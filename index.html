<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>YoBASIC</title>
    <!-- YoBASIC Styles (Track A: no Bootstrap CSS) -->
    <link rel="stylesheet" href="ybs.css">
    <link rel="stylesheet" href="ybs-compat.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!-- jQuery & jQuery Terminal -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.terminal/css/jquery.terminal.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal/js/jquery.terminal.min.js"></script>

    <script src="https://unpkg.com/js-polyfills/keyboard.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jcubic/static/js/wcwidth.js"></script>

    <script src="vfs.js"></script>
    <script src="supabaseClient.js"></script>
    <script src="identity.js"></script>
    <script src="provider-examples.js"></script>
    <script src="provider-shared.js"></script>
    <script src="basic.js"></script>
    <script src="src/modules/ui.js"></script>
    <script src="src/modules/g.js"></script>
    <script src="projectManager.js"></script>
    <script src="chat.js"></script>
    <!-- CodeMirror 5 (free, MIT) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/lint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/mode/simple.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <!-- HTML mode dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <link rel="stylesheet" href="ui/yobasic-ui.css">
    <style>
        :root {
            --nav-height: 56px;
            --editor-caret-color: #FFD400;
            --tabs-pad: 40px; /* default tabs bar height reserve */
            /* Theme variables (defaults match YoBASIC Dark) */
            --app-bg: #0b1b3b;
            --app-fg: #e6f0ff;
            --accent: #FF6600;
            --border: #1e2a55;
            --editor-bg: #031634;
            --editor-fg: #e6f0ff;
            --terminal-bg: #001a33;
            --terminal-fg: #e6f0ff;
        }
        html, body { height: 100%; }
        body {
            background: var(--app-bg, #0b1b3b); /* subtle QBasic navy vibe */
            color: var(--app-fg, #e6f0ff);
            font-family: "Courier New", Consolas, "Lucida Console", monospace;
        }
        .navbar-brand, .nav-link, .dropdown-item { user-select: none; }
        .qb-underline { text-decoration: underline; }
        /* layout */
        #work-area { height: calc(100vh - var(--nav-height)); margin-top: var(--nav-height); }
        /* editor background base and variable (used by CodeMirror internals) */
        #editor-pane { background: var(--editor-bg, #031634); --editor-bg: var(--editor-bg, #031634); }
        /* Soften/remove bright seam under the editor caused by Bootstrap's .border-bottom on dark theme */
        #editor-pane.border-bottom {
            /* Bootstrap's utility uses !important, so we match it to override */
            border-bottom: 1px solid #1e2a55 !important;
        }
        .editor-textarea, #editor { width: 100%; height: 100%; resize: none; background: transparent; color: var(--editor-fg, #e6f0ff); border: none; outline: none; caret-color: var(--editor-caret-color); }
        .editor-view { display: none; height: 100%; }
        .editor-view.active { display: block; }
        /* Tabs bar ‚Äî fix to viewport under navbar and style first tab (fixed tab) specially */
        /* We use left/right offsets to align with slide-out drawers. */
        #editor-tabs {
            position: fixed;
            top: var(--nav-height);
            left: var(--left-offset, 0px);
            right: var(--right-offset, 0px);
            z-index: 1050;
            background: var(--editor-bg, #031634);
            margin-bottom: .5rem; /* kept for visual spacing; actual space is reserved via --tabs-pad */
        }
        /* Reserve vertical space for the fixed tab bar inside the editor pane */
        #editor-pane { padding-top: calc(0.5rem + var(--tabs-pad, 40px)); }
        #editor-tabs .nav-link { display: flex; align-items: center; gap: .25rem; user-select: none; }
        #editor-tabs .tab-close { font-weight: bold; opacity: .7; cursor: pointer; }
        #editor-tabs .tab-close:hover { opacity: 1; }
        /* Special colors for the first tab (data-tab-id="0"): active accent bg + black text; inactive accent text on default bg */
        #editor-tabs .nav-link[data-tab-id="0"].active { background: var(--accent, #FF6600) !important; color: #000000 !important; border-color: var(--accent, #FF6600) var(--accent, #FF6600) transparent !important; }
        #editor-tabs .nav-link[data-tab-id="0"]:not(.active) { color: var(--accent, #FF6600) !important; }
        /* ‚Äú+‚Äù add-tab button */
        #add-tab-btn { padding: .25rem .5rem; line-height: 1; }
        #add-tab-btn .plus { font-weight: bold; font-size: 1rem; }
        #terminal-pane, #terminal { height: 100%; }
        /* make terminal host a positioning context for subtle toolbar */
        #terminal { position: relative; }
        /* Subtle terminal toolbar */
        #terminal-toolbar { position: absolute; top: 6px; left: 30%; transform: translateX(-50%); background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 2px 6px; display: flex; gap: 8px; align-items: center; z-index: 5; opacity: .75; }
        #terminal-toolbar:hover { opacity: 1; }
        #terminal-toolbar button { background: transparent; border: 0; color: #e6f0ff; padding: 2px 4px; line-height: 1; font-size: 14px; cursor: pointer; opacity: .9; }
        #terminal-toolbar button:hover { opacity: 1; color: #fff; }
        #terminal-toolbar .sep { width:1px; height:14px; background: rgba(255,255,255,0.2); }
        /* Left-side terminal host under accordion */
        #left-terminal-host { display: none; }
        #terminal-side-host { width: 100%; background: var(--terminal-bg, #001a33); border: 1px solid var(--border, #1e2a55); border-radius: 4px; overflow: hidden; }
        /* Floating dialog for terminal */
        #terminal-dialog { position: fixed; top: 15%; left: 15%; width: 70%; height: 60%; background: var(--app-bg, #0b1b3b); border: 1px solid var(--border, #1e2a55); border-radius: 6px; box-shadow: 0 12px 28px rgba(0,0,0,.6); z-index: 20000; display: none; resize: both; overflow: hidden; }
        #terminal-dialog .td-header { height: 30px; display: flex; align-items: center; justify-content: center; user-select: none; cursor: move; background: rgba(0,0,0,.35); border-bottom: 1px solid rgba(255,255,255,0.12); color: #e6f0ff; font-size: 12px; letter-spacing: .08em; text-transform: uppercase; }
        #terminal-dialog .td-body { position: absolute; inset: 30px 0 0 0; }
        /* jQuery Terminal theme tweaks */
        #terminal .terminal { --size: 1rem; }
        .terminal, .terminal .terminal-output { background: var(--terminal-bg, #001a33); color: var(--terminal-fg, #e6f0ff); }
        .terminal .prompt { color: #9ad1ff; }
        .terminal .cursor { background: #9ad1ff; }
        /* CodeMirror sizing and gutters */
        .CodeMirror { height: 100%; font-family: inherit; font-size: inherit; background: var(--editor-bg, #031634); color: inherit; }
        /* Nudge editor content down a few pixels so the first line never hugs or hides under the fixed tabs bar */
        .CodeMirror-lines { padding-top: 32px; }
        .CodeMirror-gutters { padding-top: 32px; }
        /* When CodeMirror scrolls programmatically, keep a small top breathing room */
        .CodeMirror-scroll { scroll-padding-top: 32px; }
        /* Fallback textarea editor (before CM attaches or if disabled) */
        .editor-textarea, #editor { padding-top: 32px; }
        /* ensure internal scroll areas and fillers match editor background to avoid horizontal banding */
        .CodeMirror-scroll,
        .CodeMirror-lines,
        .CodeMirror-sizer,
        .CodeMirror-gutter-filler,
        .CodeMirror-scrollbar-filler { background: var(--editor-bg, #031634) !important; }
        .CodeMirror-gutters { background: var(--app-bg, #0b1b3b); border-right: 1px solid var(--border, #1e2a55); }
        .CodeMirror-linenumber { color: #7fa6d9; }
        /* Editor caret color (CodeMirror) */
        .CodeMirror div.CodeMirror-cursor { border-left: 2px solid var(--editor-caret-color); }
        .cm-fat-cursor .CodeMirror-cursor { width: auto; border: 0; background: var(--editor-caret-color) !important; opacity: 0.9; }
        .CodeMirror-overwrite .CodeMirror-cursor { border-left: 0; border-bottom: 2px solid var(--editor-caret-color); }
        /* Buttons */
        .toolbar .btn { margin-left: .25rem; }
        /* Splash overlay */
        #splash-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--app-bg, #0b1b3b); /* match page bg */
            z-index: 9999; /* above navbar */
        }
        #splash-overlay img {
            max-width: 800px;
            width: 90%;
            height: auto;
            image-rendering: pixelated; /* 90s vibe crispness on some browsers */
        }
    </style>
</head>
<body>
<div id="splash-overlay"><img src="spash.png" alt="YoBASIC Splash" onerror="this.onerror=null; this.src='splash.png';"></div>
<nav id="topnav" class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">üå±YoBASIC</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item dropdown">
                    <a id="menu-file" class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">File</a>
                    <ul class="dropdown-menu" aria-labelledby="menu-file">
                        <li><a class="dropdown-item" href="#" data-action="file-new" data-key="n"><span class="qb-underline">N</span>ew</a></li>
                        <li><a class="dropdown-item" href="#" data-action="file-open" data-key="o"><span class="qb-underline">O</span>pen</a></li>
                        <li><a class="dropdown-item" href="#" data-action="file-save" data-key="s"><span class="qb-underline">S</span>ave</a></li>
                        <li><a class="dropdown-item" href="#" data-action="file-saveas" data-key="a">Save <span class="qb-underline">A</span>s</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-action="file-close" data-key="c"><span class="qb-underline">C</span>lose</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-action="proj-new" data-key="p">New <span class="qb-underline">P</span>roject</a></li>
                        <li><a class="dropdown-item" href="#" data-action="proj-open" data-key="j">Open Pro<span class="qb-underline">j</span>ect</a></li>
                        <li><a class="dropdown-item" href="#" data-action="proj-close" data-key="l">C<span class="qb-underline">l</span>ose Project</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a id="menu-tools" class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Tools</a>
                    <ul class="dropdown-menu" aria-labelledby="menu-tools">
                        <li><a class="dropdown-item" href="#" data-action="tool-1" data-key="1">Tool 1</a></li>
                        <li><a class="dropdown-item" href="#" data-action="tool-2" data-key="2">Tool 2</a></li>
                        <li><a class="dropdown-item" href="#" data-action="tool-3" data-key="3">Tool 3</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a id="menu-help" class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Help</a>
                    <ul class="dropdown-menu" aria-labelledby="menu-help">
                        <li><a class="dropdown-item" href="desktop.html" target="_blank" data-key="d"><span class="qb-underline">D</span>esktop</a></li>
                        <li><a class="dropdown-item" href="test.html" target="_blank" data-key="m"><span class="qb-underline">M</span>inimal IDE</a></li>
                        <li><a class="dropdown-item" href="https://blackrushbasic.com/" target="_blank" data-key="g">Reference and <span class="qb-underline">G</span>uide</a></li>
                        <li><a class="dropdown-item text-danger" href="#" data-action="help-reset" data-key="r"><span class="qb-underline">R</span>eset Defaults</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-action="about" data-key="a">About</a></li>
                    </ul>
                </li>
            </ul>
            <div class="toolbar d-flex ms-auto">
                <button id="btn-exec" class="btn btn-outline-light btn-sm d-none" title="Execute selection"><i class="bi bi-lightning-charge-fill me-1"></i>Exec(f8)</button>
                <button id="btn-run" class="btn btn-outline-light btn-sm" title="Run (execute program)"><i class="bi bi-play-fill me-1"></i>Run(f9)</button>
                <button id="btn-clear" class="btn btn-outline-success btn-sm" title="Clear Output"><i class="bi bi-ban-fill me-1"></i>Clear</button>
                <button id="btn-bug" class="btn btn-outline-warning btn-sm" title="Toggle Tron/Troff (Debug Mode)"><i class="bi bi-bug-fill me-1"></i>Tron/Troff</button>
                <button id="btn-build" class="btn btn-outline-info btn-sm" title="Build"><i class="bi bi-hammer me-1"></i>Build</button>
                <button id="btn-settings" class="btn btn-outline-light btn-sm" title="Settings"><i class="bi bi-gear-fill me-1"></i>Settings</button>
                <button id="btn-identity" class="btn btn-outline-primary btn-sm ms-2" title="Identity"><i class="bi bi-person-badge me-1"></i><span id="identity-label">Login</span></button>
            </div>
        </div>
    </div>
</nav>

<!-- Hidden initial program seed that populates the very first editor on first load -->
<div id="initial-editor-seed" style="display:none">PRINT "Hello World"</div>

<div id="work-area" class="container-fluid p-0">
    <div id="editor-pane" class="d-none p-2 border-bottom" style="height: 60%; display: flex; flex-direction: column;">
        <ul id="editor-tabs" class="nav nav-tabs small mb-2"></ul>
        <div id="editor-views" class="flex-grow-1">
            <div class="editor-view active" data-tab-id="0" style="height: 100%;">
                <textarea id="editor" class="editor-textarea" spellcheck="false"></textarea>
            </div>
        </div>
    </div>
    <div id="terminal-pane" class="p-0" style="height: calc(100vh - var(--nav-height));">
    <div id="terminal" class="h-100">
        <!-- subtle toolbar -->
        <div id="terminal-toolbar" title="Terminal position">
            <button id="tt-side" title="Side"><i class="bi bi-layout-sidebar-inset"></i></button>
            <button id="tt-center" title="Center"><i class="bi bi-layout-split"></i></button>
            <button id="tt-dialog" title="Dialog"><i class="bi bi-layout-text-window-reverse"></i></button>
            <div class="sep"></div>
            <button id="tt-pin" title="Pin toolbar"><i class="bi bi-pin-angle"></i></button>
        </div>
    </div>
    </div>
</div>

<!-- About Modal -->
<div class="modal fade" id="modalAbout" tabindex="-1" aria-labelledby="aboutLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="aboutLabel">About</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>YoBASIC is a subset of the Basilüåø programming language and presented here as an interactive learning tool for beginners and a sandbox for experienced developers.</p>
        <p>Both the Editor and the file I/O functions in BASIC make use of a simulated file system that uses local storage in your browser and will persist between sessions. </p>
        <p><a class="link-info" href="https://basilbasic.com" target="_blank" rel="noopener">Visit basilbasic.com</a></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Identity Modal -->
<div class="modal fade" id="modalIdentity" tabindex="-1" aria-labelledby="identityLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="identityLabel">Identity</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="identity-status" class="mb-3 small text-secondary">You are not logged in.</div>
        <div id="identity-forms">
          <ul class="nav nav-tabs" id="identityTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-login-tab" data-bs-toggle="tab" data-bs-target="#tab-login" type="button" role="tab" aria-controls="tab-login" aria-selected="true">Log In</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-signup-tab" data-bs-toggle="tab" data-bs-target="#tab-signup" type="button" role="tab" aria-controls="tab-signup" aria-selected="false">Create Identity</button>
            </li>
          </ul>
          <div class="tab-content p-3">
            <div class="tab-pane fade show active" id="tab-login" role="tabpanel" aria-labelledby="tab-login-tab">
              <div class="mb-2">
                <label class="form-label">Username or Email</label>
                <input id="login-username" type="text" class="form-control form-control-sm" placeholder="yourname or you@example.com" />
              </div>
              <div class="mb-2">
                <label class="form-label">Password</label>
                <input id="login-password" type="password" class="form-control form-control-sm" />
              </div>
              <button id="btn-login" type="button" class="btn btn-primary">Log In</button>
            </div>
            <div class="tab-pane fade" id="tab-signup" role="tabpanel" aria-labelledby="tab-signup-tab">
              <div class="mb-2">
                <label class="form-label">Username</label>
                <input id="signup-username" type="text" class="form-control form-control-sm" placeholder="yourname" />
              </div>
              <div class="mb-2">
                <label class="form-label">Email</label>
                <input id="signup-email" type="email" class="form-control form-control-sm" placeholder="you@example.com" />
              </div>
              <div class="mb-2">
                <label class="form-label">Password</label>
                <input id="signup-password" type="password" class="form-control form-control-sm" />
              </div>
              <div class="form-text text-secondary mb-2">After signing up, check your email and confirm your address, then return here to log in.</div>
              <button id="btn-signup" type="button" class="btn btn-success">Create Identity</button>
            </div>
          </div>
        </div>
        <div id="identity-loggedin" class="d-none">
          <p>You are <span id="whoami"></span>.</p>
          <button id="btn-logout" type="button" class="btn btn-warning">Log Out</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="modalSettings" tabindex="-1" aria-labelledby="settingsLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="settingsLabel">Settings</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-appearance-tab" data-bs-toggle="tab" data-bs-target="#tab-appearance" type="button" role="tab" aria-controls="tab-appearance" aria-selected="true">Appearance</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-2-tab" data-bs-toggle="tab" data-bs-target="#tab-2" type="button" role="tab" aria-controls="tab-2" aria-selected="false">Colors</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-3-tab" data-bs-toggle="tab" data-bs-target="#tab-3" type="button" role="tab" aria-controls="tab-3" aria-selected="false">Tab 3</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-4-tab" data-bs-toggle="tab" data-bs-target="#tab-4" type="button" role="tab" aria-controls="tab-4" aria-selected="false">Tab 4</button>
          </li>
        </ul>
        <div class="tab-content p-3">
          <div class="tab-pane fade show active" id="tab-appearance" role="tabpanel" aria-labelledby="tab-appearance-tab">
            <div class="row g-3">
              <div class="col-md-6">
                <h6>Editor</h6>
                <div class="mb-2">
                  <label class="form-label">Font Face</label>
                  <select id="editor-font" class="form-select form-select-sm">
                    <option>Courier New</option>
                    <option>Consolas</option>
                    <option>Fira Code</option>
                    <option>Monaco</option>
                    <option>Lucida Console</option>
                    <option>IBM Plex Mono</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Font Size (px)</label>
                  <input id="editor-size" type="number" min="10" max="48" step="1" class="form-control form-control-sm" />
                </div>
                <div class="mb-2">
                  <label class="form-label">Font Color</label>
                  <input id="editor-color" type="color" class="form-control form-control-color form-control-sm" />
                </div>
                <div class="mb-2">
                  <label class="form-label">Background</label>
                  <input id="editor-bg" type="color" class="form-control form-control-color form-control-sm" />
                </div>
              </div>
              <div class="col-md-6">
                <h6>Terminal</h6>
                <div class="mb-2">
                  <label class="form-label">Font Face</label>
                  <select id="terminal-font" class="form-select form-select-sm">
                    <option>Courier New</option>
                    <option>Consolas</option>
                    <option>Fira Code</option>
                    <option>Monaco</option>
                    <option>Lucida Console</option>
                    <option>IBM Plex Mono</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Font Size (px)</label>
                  <input id="terminal-size" type="number" min="10" max="48" step="1" class="form-control form-control-sm" />
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="tab-2" role="tabpanel" aria-labelledby="tab-2-tab">
            <div class="row g-3">
              <div class="col-md-6">
                <h6>Theme</h6>
                <div class="mb-2">
                  <label class="form-label">Choose</label>
                  <select id="theme-select" class="form-select form-select-sm">
                    <option value="themes/YoBASIC Dark.json">YoBASIC Dark (built-in)</option>
                    <option value="themes/YoBASIC Light.json">YoBASIC Light (built-in)</option>
                  </select>
                </div>
                <div class="mb-2 d-flex gap-2 flex-wrap">
                  <button id="btn-theme-apply" class="btn btn-primary btn-sm">Apply</button>
                  <button id="btn-theme-save-local" class="btn btn-secondary btn-sm">Save As (Local)</button>
                  <button id="btn-theme-save-shared" class="btn btn-warning btn-sm">Save to Supabase</button>
                </div>
                <div class="mb-2 d-flex gap-2 flex-wrap">
                  <button id="btn-theme-export" class="btn btn-outline-info btn-sm">Export JSON</button>
                  <button id="btn-theme-import" class="btn btn-outline-light btn-sm">Import JSON</button>
                  <button id="btn-theme-reset" class="btn btn-outline-danger btn-sm">Reset to Default</button>
                </div>
              </div>
              <div class="col-md-6">
                <h6>Colors</h6>
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label">App Background</label>
                    <input id="color-app-bg" type="color" class="form-control form-control-color form-control-sm" />
                  </div>
                  <div class="col-6">
                    <label class="form-label">App Text</label>
                    <input id="color-app-fg" type="color" class="form-control form-control-color form-control-sm" />
                  </div>
                  <div class="col-6">
                    <label class="form-label">Accent</label>
                    <input id="color-accent" type="color" class="form-control form-control-color form-control-sm" />
                  </div>
                  <div class="col-6">
                    <label class="form-label">Border</label>
                    <input id="color-border" type="color" class="form-control form-control-color form-control-sm" />
                  </div>
                  <div class="col-6">
                    <label class="form-label">Editor BG</label>
                    <input id="color-editor-bg" type="color" class="form-control form-control-color form-control-sm" />
                  </div>
                  <div class="col-6">
                    <label class="form-label">Editor Text</label>
                    <input id="color-editor-fg" type="color" class="form-control form-control-color form-control-sm" />
                  </div>
                  <div class="col-6">
                    <label class="form-label">Terminal BG</label>
                    <input id="color-terminal-bg" type="color" class="form-control form-control-color form-control-sm" />
                  </div>
                  <div class="col-6">
                    <label class="form-label">Terminal Text</label>
                    <input id="color-terminal-fg" type="color" class="form-control form-control-color form-control-sm" />
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="tab-3" role="tabpanel" aria-labelledby="tab-3-tab">
            <p class="text-muted">No content yet.</p>
          </div>
          <div class="tab-pane fade" id="tab-4" role="tabpanel" aria-labelledby="tab-4-tab">
            <p class="text-muted">No content yet.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-save-settings" type="button" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Open Dialog -->
<div class="modal fade" id="modalOpen" tabindex="-1" aria-labelledby="openLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="openLabel">OPEN</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-4 border-end">
            <div class="list-group" id="open-folders">
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark active" data-folder="Root">Root</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="projects">projects</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="demo">demo</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="examples">examples</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="data">data</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="shared">shared</button>
              <div id="open-projects" class="mt-2"></div>
              <div id="open-shared-owners" class="mt-2"></div>
            </div>
          </div>
          <div class="col-8">
            <div class="small text-secondary mb-2">Double-click to open.</div>
            <div class="list-group" id="open-files" style="max-height: 50vh; overflow:auto"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-open-ok" type="button" class="btn btn-primary" disabled>Open</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Save As Dialog -->
<div class="modal fade" id="modalSaveAs" tabindex="-1" aria-labelledby="saveasLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="saveasLabel">SAVE FILE</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-4 border-end">
            <div class="list-group" id="save-folders">
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark active" data-folder="Root">Root</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="projects">projects</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="demo" disabled>demo</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="examples" disabled>examples</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="data" disabled>data</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="shared">shared</button>
            </div>
          </div>
          <div class="col-8">
            <div class="mb-2">
              <label class="form-label">File name</label>
              <input id="saveas-name" type="text" class="form-control form-control-sm" placeholder="MYPROGRAM.BAS" />
              <div class="form-text text-secondary">Programs are saved in Root as .BAS files. You can also use subfolders like chapter1/HELLO.BAS</div>
            </div>
            <div id="save-files" class="list-group" style="max-height: 50vh; overflow:auto"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-saveas-ok" type="button" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Bundle (with Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (function(){
    var __EVAL = (s) => eval(`void (__EVAL = ${__EVAL}); ${s}`);
    // Editor cursor color constant ‚Äî adjust this to change caret color everywhere
    const EDITOR_CARET_COLOR = '#FFD400'; // Yellow by default
    try { document.documentElement.style.setProperty('--editor-caret-color', EDITOR_CARET_COLOR); } catch(_) {}
    let term, basic;
    let debugOn = false;
    let currentMenu = null; // bootstrap.Dropdown instance

    // --- Tabbed editor state ---
    const MAX_TABS = 20; // change to adjust tab limit
    let tabs = [];
    let activeTabId = 0;
    let nextTabId = 1; // 0 is the fixed first tab
    // CodeMirror lint timing (high-water mark)
    let __lintMaxMs = 0;

    // --- Theme Manager ---
    const ThemeManager = (function(){
        const ACTIVE_REF_KEY = 'basic_active_theme_ref';
        const ACTIVE_JSON_KEY = 'basic_active_theme_json';
        const LOCAL_THEMES_KEY = 'basic_themes';
        const BUILTIN_DEFAULT = 'themes/YoBASIC Dark.json';

        function getLocalThemesMap(){
            try { return JSON.parse(localStorage.getItem(LOCAL_THEMES_KEY) || '{}') || {}; } catch(e){ return {}; }
        }
        function setLocalThemesMap(map){
            try { localStorage.setItem(LOCAL_THEMES_KEY, JSON.stringify(map || {})); } catch(e){}
        }

        function setRootVars(vars){
            if (!vars) return;
            const root = document.documentElement.style;
            Object.entries(vars).forEach(([k,v])=>{ try{ root.setProperty(k, String(v)); }catch(_){ } });
        }

        function apply(theme, ref){
            if (!theme || typeof theme !== 'object') return;
            window.__activeTheme = JSON.parse(JSON.stringify(theme));
            if (theme.variables) setRootVars(theme.variables);
            // Apply fonts/sizes if provided
            try{
                const s = {};
                if (theme.editor) s.editor = theme.editor;
                if (theme.terminal) s.terminal = theme.terminal;
                if (s.editor || s.terminal) applySettings(s);
            }catch(_){ }
            try{
                localStorage.setItem(ACTIVE_JSON_KEY, JSON.stringify(theme));
                if (ref) localStorage.setItem(ACTIVE_REF_KEY, ref);
            }catch(_){ }
        }

        async function loadRef(ref){
            if (!ref) return null;
            if (typeof ref === 'object') return ref;
            const r = String(ref);
            try{
                if (r.startsWith('local:')){
                    const name = r.slice(6);
                    const map = getLocalThemesMap();
                    return map[name] || null;
                }
                if (r.startsWith('shared/') || r.startsWith('projects/') || r.startsWith('data/') || r.startsWith('themes/')){
                    // Try fetch for built-ins under themes/, else VFS
                    if (r.startsWith('themes/')){
                        const resp = await fetch(r);
                        if (resp && resp.ok){ return await resp.json(); }
                    }
                    if (window.__vfsInstance__ && __vfsInstance__.readDataAsync){
                        const txt = await __vfsInstance__.readDataAsync(r);
                        if (txt){ return JSON.parse(txt); }
                    }
                }
            }catch(_){ }
            return null;
        }

        async function applyActiveOrDefault(){
            let ref = null;
            try{ ref = localStorage.getItem(ACTIVE_REF_KEY); }catch(_){ }
            let theme = null;
            if (ref){ theme = await loadRef(ref); }
            if (!theme){
                try{
                    const resp = await fetch(BUILTIN_DEFAULT);
                    if (resp && resp.ok) theme = await resp.json();
                }catch(_){ }
                ref = BUILTIN_DEFAULT;
            }
            if (theme){ apply(theme, ref); }
            return theme;
        }

        function exportJson(theme){ return JSON.stringify(theme || window.__activeTheme || {}, null, 2); }

        function importJson(str){
            try{ const obj = JSON.parse(String(str||'')); return obj && typeof obj === 'object' ? obj : null; }catch(_){ return null; }
        }

        function saveLocal(name, theme){
            const nm = String(name||'').trim(); if (!nm) throw new Error('Enter a theme name.');
            const t = theme || window.__themeDraft || window.__activeTheme; if (!t) throw new Error('No theme to save.');
            const map = getLocalThemesMap(); map[nm] = t; setLocalThemesMap(map);
            // Also mirror into local VFS under themes/
            try{ if (window.__vfsInstance__){ __vfsInstance__.writeData(`themes/${nm}.json`, JSON.stringify(t, null, 2)); } }catch(_){ }
            return { name: nm, theme: t };
        }

        async function saveShared(name, theme){
            const nm = String(name||'').trim(); if (!nm) throw new Error('Enter a theme name.');
            const t = theme || window.__themeDraft || window.__activeTheme; if (!t) throw new Error('No theme to save.');
            const me = (window.Identity && Identity.getCurrentUser && Identity.getCurrentUser()) || null;
            if (!me) throw new Error('Log in to save to Supabase.');
            const path = `shared/${me.username}/themes/${nm}.json`;
            if (!window.__vfsInstance__ || !__vfsInstance__.writeDataAsync) throw new Error('VFS not ready.');
            await __vfsInstance__.writeDataAsync(path, JSON.stringify(t, null, 2));
            return { path, theme: t };
        }

        return { apply, loadRef, applyActiveOrDefault, exportJson, importJson, saveLocal, saveShared };
    })();

    // Define BASIC mode using live keywords from interpreter
    try{
        var BASIC_KEYWORDS = (window.YoBasic && YoBasic.getKeywords) ? YoBasic.getKeywords() : [
          'PRINT','INPUT','LET','IF','THEN','ELSE','END','FOR','TO','STEP','NEXT','WHILE','WEND','DO','LOOP'
        ];
        if (window.CodeMirror && CodeMirror.defineSimpleMode){
            CodeMirror.defineSimpleMode('yobasic', {
              start: [
                { regex: /\/\/.*$/, token: 'comment' },
                { regex: /\bREM\b.*$/i, token: 'comment' },
                { regex: /"([^"\\]|\\.)*"?/, token: 'string' },
                { regex: /'([^'\\]|\\.)*'?/, token: 'string' },
                { regex: /\b(\d+\.\d*|\.\d+|\d+)\b/, token: 'number' },
                { regex: new RegExp("\\b(" + BASIC_KEYWORDS.join("|") + ")\\b", "i"), token: 'keyword' },
                { regex: /\b(AND|OR|NOT|MOD)\b/i, token: 'operator' },
                { regex: /[+\-*/=<>()]/, token: 'operator' },
                { regex: /[A-Z][A-Z0-9_]*\$/i, token: 'variable-2' },
                { regex: /[A-Z][A-Z0-9_]*/i, token: 'variable' }
              ],
              meta: { lineComment: "//" }
            });
        }
    }catch(_){ /* mode define failed */ }

    function computeModeForName(name){
        const n = String(name||'').trim();
        // Default to BASIC highlighting when no specific file name is associated yet
        if (n === '' || /^untitled$/i.test(n)) return 'yobasic';
        if (/\.bas$/i.test(n)) return 'yobasic';
        if (/\.html?$/i.test(n)) return 'htmlmixed';
        return null; // plain text
    }

    function basicLint(text, options, cm){
        try{
            if (!window.YoBasic || !YoBasic.checkSyntax) return [];
            const t0 = (window.performance && performance.now) ? performance.now() : Date.now();
            const res = YoBasic.checkSyntax(text);
            const t1 = (window.performance && performance.now) ? performance.now() : Date.now();
            const dt = Math.round(t1 - t0);
            if (dt > __lintMaxMs){ __lintMaxMs = dt; try{ console.warn(`Warning: Lint took ${dt}ms`); }catch(_){ } }
            if (res.ok) return [];
            return (res.errors||[]).map(function(e){
                const from = CodeMirror.Pos(Math.max(0, e.line|0), Math.max(0, e.column|0));
                const to = CodeMirror.Pos(Math.max(0, (e.endLine!=null?e.endLine:e.line)|0), Math.max(0, (e.endColumn!=null?e.endColumn:(e.column|0)+1)));
                return { from, to, message: e.message || 'Syntax error', severity: 'error' };
            });
        }catch(_){ return []; }
    }

    function ensureCodeMirrorForTab(tab){
        if (!tab || tab.cm || !window.CodeMirror) return;
        const mode = computeModeForName(tab.fullName);
        tab.cm = CodeMirror.fromTextArea(tab.textarea, {
            mode: mode || null,
            lineNumbers: true,
            lineWrapping: true,
            matchBrackets: true,
            theme: 'yobasic',
            gutters: ['CodeMirror-linenumbers','CodeMirror-lint-markers']
        });
        // Enable lint only for BASIC files
        if (mode === 'yobasic'){
            tab.cm.setOption('lint', { getAnnotations: basicLint, async: false, delay: 800 });
        } else {
            tab.cm.setOption('lint', false);
        }
        // Forward changes to autosave + keep hidden textarea in sync for legacy reads
        tab.cm.on('change', function(cm){
            try{ tab.textarea.value = cm.getValue(); }catch(_){}
            try{ saveCode(cm.getValue()); }catch(_){}
            try{ updateExecButtonVisibility(); }catch(_){}
            // Dirty tracking vs last saved content
            try{
                const cur = cm.getValue();
                if (tab.__suppressNextDirty){
                    tab.__suppressNextDirty = false;
                    tab.savedContent = cur;
                    setTabDirty(tab, false);
                } else {
                    setTabDirty(tab, cur !== (tab.savedContent ?? ''));
                }
            }catch(_){ }
        });
        tab.cm.on('cursorActivity', function(){ try{ updateExecButtonVisibility(); }catch(_){} });
        // On focus, if file has >15 lines and not in dialog mode, dock terminal to side below accordion
        tab.cm.on('focus', function(){
            try{
                if (window.__terminalMode === 'dialog') return;
                const lines = (tab.cm && tab.cm.lineCount) ? tab.cm.lineCount() : 0;
                if (lines > 15){
                    if (typeof window.setTerminalMode === 'function') window.setTerminalMode('side');
                }
            }catch(_){ }
        });
        // Make old focus() calls target CodeMirror
        try{ tab.textarea.focus = function(){ try{ tab.cm.focus(); }catch(_){ } }; }catch(_){}
    }

    function refreshAndApplyMode(tab){
        if (!tab || !tab.cm) return;
        const mode = computeModeForName(tab.fullName);
        tab.cm.setOption('mode', mode || null);
        if (mode === 'yobasic') tab.cm.setOption('lint', { getAnnotations: basicLint, async:false, delay: 800 });
        else tab.cm.setOption('lint', false);
        setTimeout(()=>{ try{ tab.cm.refresh(); }catch(_){} }, 0);
    }
    function findTabByFullName(fullName){
        if (!fullName) return null;
        const fn = String(fullName).toLowerCase();
        return tabs.find(t => String(t.fullName||'').toLowerCase() === fn) || null;
    }
    function renderTabButtonFor(tab){
        const btn = document.querySelector(`#editor-tabs [data-tab-id="${tab.id}"]`);
        if (!btn) return;
        const titleEl = btn.querySelector('.tab-title');
        const dirtyEl = btn.querySelector('.tab-dirty');
        if (titleEl) titleEl.textContent = tab.displayName || 'Untitled';
        if (dirtyEl) dirtyEl.textContent = tab.dirty ? '*' : '';
        btn.title = tab.fullName || tab.displayName || 'Untitled';
    }
    function setTabDirty(tab, dirty){
        if (!tab) return;
        tab.dirty = !!dirty;
        renderTabButtonFor(tab);
    }
    function ensureAddTabButton(){
        const list = document.getElementById('editor-tabs');
        if (!list) return;
        if (document.getElementById('add-tab-btn')) return;
        const li = document.createElement('li'); li.className = 'nav-item'; li.id = 'add-tab-li';
        const btn = document.createElement('button'); btn.className = 'nav-link'; btn.type = 'button'; btn.id = 'add-tab-btn'; btn.title = 'New File (Ctrl+N)';
        btn.innerHTML = '<span class="plus">+</span>';
        li.appendChild(btn); list.appendChild(li);
        btn.addEventListener('click', function(e){ e.preventDefault(); onFileNew(); });
    }
    
    function getActiveTab(){ return tabs.find(t => t.id === activeTabId); }
    function getTabById(id){ return tabs.find(t => t.id === id); }
    function getActiveEditor(){ const t = getActiveTab(); return t ? t.textarea : document.getElementById('editor'); }
    function getActiveCode(){
        const t = getActiveTab();
        if (t && t.cm) { try{ return t.cm.getValue(); }catch(_){ } }
        const ed = getActiveEditor(); return ed ? (ed.value || '') : '';
    }
    function setActiveCode(text){
        const t = getActiveTab();
        if (t && t.cm){ try{ t.cm.setValue(String(text||'')); }catch(_){ } }
        const ed = getActiveEditor(); if (ed) ed.value = String(text||'');
    }
    function focusActiveEditor(){ const t=getActiveTab(); if (t && t.cm){ try{ t.cm.focus(); }catch(_){} return; } const ed=getActiveEditor(); if (ed) try{ ed.focus(); }catch(_){} }
    function setTabTitle(tabId, displayName, fullName){
        const tab = getTabById(tabId); if (!tab) return;
        tab.displayName = displayName || 'Untitled';
        tab.fullName = fullName || null;
        renderTabButtonFor(tab);
    }
    function activateTab(tabId){
        const tab = getTabById(tabId); if (!tab) return;
        // toggle tab buttons
        document.querySelectorAll('#editor-tabs .nav-link').forEach(el=>el.classList.remove('active'));
        const btn = document.querySelector(`#editor-tabs [data-tab-id="${tabId}"]`);
        if (btn) btn.classList.add('active');
        // toggle views
        document.querySelectorAll('#editor-views .editor-view').forEach(v=>v.classList.remove('active'));
        const view = document.querySelector(`#editor-views .editor-view[data-tab-id="${tabId}"]`);
        if (view) view.classList.add('active');
        activeTabId = tabId;
        // sync globals used by existing dialogs
        currentFileName = tab.fullName || null;
        currentFileReadOnly = !!tab.readOnly;
        // Ensure CodeMirror and set mode
        try{ ensureCodeMirrorForTab(tab); refreshAndApplyMode(tab); }catch(_){}
        // focus editor
        setTimeout(()=>{ try{ focusActiveEditor(); }catch(e){}; try{ updateExecButtonVisibility(); }catch(_){ } }, 0);
    }
    function buildInitialTabUi(){
        // Create first tab button if not present
        const list = document.getElementById('editor-tabs');
        if (!list) return;
        if (list.children.length === 0){
            const li = document.createElement('li'); li.className = 'nav-item';
            const btn = document.createElement('button'); btn.className = 'nav-link active'; btn.type='button'; btn.setAttribute('data-tab-id','0'); btn.title='Untitled';
            btn.innerHTML = '<span class="tab-title">Untitled</span><span class="tab-dirty" aria-hidden="true"></span> <span class="tab-close" aria-label="Close" title="Close">√ó</span>';
            li.appendChild(btn); list.appendChild(li);
            btn.addEventListener('click', function(e){ if (e.target.classList.contains('tab-close')) return; activateTab(0); });
            btn.querySelector('.tab-close').addEventListener('click', function(e){ e.stopPropagation(); closeTab(0); });
            ensureAddTabButton();
        }
        // Register first tab object using existing #editor
        if (!tabs.find(t=>t.id===0)){
            const textarea = document.getElementById('editor');
            const view = document.querySelector('#editor-views .editor-view[data-tab-id="0"]');
            const firstTab = { id: 0, textarea, view, fullName: null, readOnly: false, displayName: 'Untitled', savedContent: '', dirty: false };
            tabs.push(firstTab);
            // bind input autosave on first tab too (fallback if CM not yet attached) + dirty tracking
            textarea.addEventListener('input', function(){
                saveCode();
                try{ setTabDirty(firstTab, (textarea.value||'') !== (firstTab.savedContent||'')); }catch(_){ }
            });
            // attach Tab key handling
            try{ attachEditorKeyHandlers(textarea); }catch(_){ }
            try{ attachEditorSelectionHandlers(textarea); }catch(_){ }
            // Upgrade to CodeMirror
            try{ ensureCodeMirrorForTab(firstTab); refreshAndApplyMode(firstTab); }catch(_){}
            renderTabButtonFor(firstTab);
        }
        try{ updateTabsPad(); }catch(_){}
    }
    function createNewTab(initial){
        if (tabs.length >= MAX_TABS){ alert(`You have reached the tab limit (${MAX_TABS}). Close a tab to open another.`); return null; }
        const id = nextTabId++;
        // view
        const view = document.createElement('div'); view.className='editor-view'; view.style.height='100%'; view.setAttribute('data-tab-id', String(id));
        const ta = document.createElement('textarea'); ta.className='editor-textarea'; ta.spellcheck=false; view.appendChild(ta);
        document.getElementById('editor-views').appendChild(view);
        // button
        const li = document.createElement('li'); li.className = 'nav-item';
        const btn = document.createElement('button'); btn.className='nav-link'; btn.type='button'; btn.setAttribute('data-tab-id', String(id));
        btn.innerHTML = '<span class="tab-title">Untitled</span><span class="tab-dirty" aria-hidden="true"></span> <span class="tab-close" aria-label="Close" title="Close">√ó</span>';
        li.appendChild(btn);
        const list = document.getElementById('editor-tabs');
        const addLi = document.getElementById('add-tab-li');
        if (addLi) list.insertBefore(li, addLi); else list.appendChild(li);
        btn.addEventListener('click', function(e){ if (e.target.classList.contains('tab-close')) return; activateTab(id); });
        btn.querySelector('.tab-close').addEventListener('click', function(e){ e.stopPropagation(); closeTab(id); });
        try{ updateTabsPad(); }catch(_){ }
        // settings apply to new textarea
        const s = loadSettings();
        if (s && s.editor){
            if (s.editor.fontFamily) ta.style.fontFamily = s.editor.fontFamily + ', monospace';
            if (s.editor.fontSize) ta.style.fontSize = s.editor.fontSize + 'px';
            if (s.editor.color) ta.style.color = s.editor.color;
            if (s.editor.bg) ta.style.backgroundColor = s.editor.bg;
        }
        try{ attachEditorKeyHandlers(ta); }catch(_){ }
        try{ attachEditorSelectionHandlers(ta); }catch(_){ }
        const tab = { id, textarea: ta, view, fullName: null, readOnly: false, displayName: 'Untitled', savedContent: '', dirty: false };
        // Fallback input listener for early typing before CM attaches (rare)
        ta.addEventListener('input', function(){ saveCode(); try{ setTabDirty(tab, (ta.value||'') !== (tab.savedContent||'')); }catch(_){ } });
        tabs.push(tab);
        try{ ensureCodeMirrorForTab(tab); }catch(_){}
        // initial content/meta
        if (initial){
            if (typeof initial.content === 'string'){ ta.value = initial.content; if (tab.cm) try{ tab.cm.setValue(initial.content); }catch(_){} }
            if (initial.fullName){ tab.fullName = initial.fullName; }
            if (initial.readOnly){ tab.readOnly = !!initial.readOnly; }
            const title = initial.displayName || (initial.fullName ? (initial.fullName.includes('/')? initial.fullName.split('/').pop() : initial.fullName) : 'Untitled');
            setTabTitle(id, title, initial.fullName || title);
            // Treat opened files as not dirty initially
            tab.savedContent = (typeof initial.content === 'string') ? initial.content : (tab.textarea.value || '');
            tab.dirty = false; renderTabButtonFor(tab);
        } else {
            setTabTitle(id, 'Untitled', 'Untitled');
            tab.savedContent = tab.textarea.value || '';
            tab.dirty = false; renderTabButtonFor(tab);
        }
        // show editor and activate
        openEditor(true);
        activateTab(id);
        return tab;
    }
    // Expose a minimal bridge for external (iframe) integrations
    try{
        window.__YoBasicBridge__ = window.__YoBasicBridge__ || {
            openTab: function(initial){
                const t = createNewTab(initial || {});
                return t ? t.id : null;
            },
            activateTab: function(id){ activateTab(id); },
            openEditor: function(suppressAutoload){ openEditor(!!suppressAutoload); }
        };
    }catch(_){ /* ignore */ }
    function closeTab(id){
        const idx = tabs.findIndex(t=>t.id===id);
        if (idx < 0) return;
        const t = tabs[idx];
        // warn if unsaved changes
        if (t && t.dirty){
            const ok = confirm('This document has unsaved changes. Close anyway?');
            if (!ok) return;
        }
        if (id === 0 || tabs.length === 1){
            // clear first/only tab per spec
            const t0 = getTabById(id);
            if (t0){
                t0.textarea.value = '';
                if (t0.cm) try{ t0.cm.setValue(''); }catch(_){}
                t0.fullName = null; t0.readOnly = false; t0.savedContent = ''; setTabDirty(t0, false);
                setTabTitle(id, 'Untitled', 'Untitled'); saveCode('');
                refreshAndApplyMode(t0);
            }
            activateTab(id);
            return;
        }
        // compute previous tab id (immediate prior visually is previous in array if exists, else previous sibling in DOM)
        const prev = tabs[idx-1] || tabs[0];
        // remove DOM
        const btn = document.querySelector(`#editor-tabs [data-tab-id="${id}"]`);
        if (btn){ const li = btn.parentElement; li && li.remove(); }
        const view = document.querySelector(`#editor-views .editor-view[data-tab-id="${id}"]`);
        if (view){ view.remove(); }
        // remove from state
        tabs.splice(idx,1);
        try{ updateTabsPad(); }catch(_){ }
        // activate previous
        activateTab(prev.id);
    }
    
    async function tryLoadSharedProjectFromUrl(){
        const params = new URLSearchParams(location.search);
        const sp = params.get('sharedProject');
        if (!sp) return;
        const m = String(sp).match(/^([^\/]+)\/(.+)$/);
        if (!m) return;
        const owner = decodeURIComponent(m[1]);
        const proj = decodeURIComponent(m[2]);
        // Fetch file list for owner and hydrate only this project's files
        const prov = vfs && vfs.providers && vfs.providers.shared;
        if (!prov || !prov.listFilesForOwner || !prov.getFile) return;
        const files = await prov.listFilesForOwner(owner);
        const prefix = `shared/${owner}/projects/${proj}/`.toLowerCase();
        const matches = files.filter(f=>String(f.name).toLowerCase().startsWith(prefix));
        if (!matches.length){ console.warn('No shared files for project', proj); return; }
        for (const f of matches){
            // Fetch full content
            const full = await prov.getFile(f.name);
            if (!full) continue;
            // Compute local path under projects/<proj>/...
            const rest = full.name.slice(prefix.length);
            const localPath = `projects/${proj}/${rest}`;
            // Write to local VFS preserving kind
            vfs.writeFile(localPath, full.content || '', full.kind || 'program');
        }
        // Open project after hydration
        if (window.ProjectManager && ProjectManager.init){ ProjectManager.init(vfs); }
        if (window.ProjectManager && ProjectManager.openProject){ await ProjectManager.openProject(proj); }
    }

    // VFS and editor current file state
    let vfs = null;
    let currentFileName = null;
    let currentFileReadOnly = false;

    function setNavHeight() {
        // const h = document.getElementById('topnav').offsetHeight || 56;
        const h = 56;
        document.body.style.setProperty('--nav-height', h + 'px');
        // Ensure we reserve enough vertical space for the fixed tabs bar
        try{ updateTabsPad(); }catch(_){ }
        // adjust terminal pane height depending on editor visibility and terminal mode
        const editorPane = document.getElementById('editor-pane');
        const tp = document.getElementById('terminal-pane');
        const editorVisible = !editorPane.classList.contains('d-none');
        const mode = window.__terminalMode || 'center';
        if (editorVisible && mode === 'center'){
            editorPane.style.height = '60%';
            tp.style.height = '40%';
            tp.style.display = '';
        } else if (editorVisible && mode === 'side'){
            editorPane.style.height = '100%';
            tp.style.height = '0%';
            tp.style.display = 'none';
        } else if (mode === 'dialog'){
            // When dialog, keep editorPane at 100% if visible; terminal-pane hidden
            if (editorVisible){ editorPane.style.height = '100%'; }
            tp.style.height = '0%';
            tp.style.display = 'none';
        } else {
            // editor hidden ‚Üí terminal fills the work area when center mode, otherwise hidden
            if (mode === 'center'){ tp.style.height = '100%'; tp.style.display = ''; }
            else { tp.style.height = '0%'; tp.style.display = 'none'; }
        }
        if (window.term && term.resize) try{ term.resize(); }catch(_){ }
    }

    // Keep a CSS variable in sync with the actual height of the fixed tabs bar,
    // so the editor content can be padded down appropriately.
    function updateTabsPad(){
        const el = document.getElementById('editor-tabs');
        if (!el) return;
        const h = Math.max(32, el.offsetHeight || 0);
        document.documentElement.style.setProperty('--tabs-pad', h + 'px');
    }

    function saveCode(value) {
        try {
            const code = (typeof value === 'string') ? value : getActiveCode();
            localStorage.setItem('basic_editor_code', code);
        } catch(e) {}
    }
    function loadCode() {
        try { return localStorage.getItem('basic_editor_code'); } catch(e) { return null; }
    }

    function saveSettings(obj) {
        try { localStorage.setItem('basic_settings', JSON.stringify(obj)); } catch(e) {}
    }
    function loadSettings() {
        try { return JSON.parse(localStorage.getItem('basic_settings') || '{}'); } catch(e) { return {}; }
    }

    function resetToDefaults() {
        const msg = 'Are you sure you want to reset all settings to defaults?\n\n' +
                    'This will clear your editor settings, window positions, and local storage files. ' +
                    'Your shared files and login session will be retained.';
        if (confirm(msg)) {
            const toRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && !key.startsWith('sb-')) {
                    toRemove.push(key);
                }
            }
            toRemove.forEach(key => localStorage.removeItem(key));
            alert('Settings have been reset. The page will now reload.');
            window.location.reload();
        }
    }

    function applySettings(s) {
        if (s.editor) {
            // Apply editor typography/colors
            document.querySelectorAll('.editor-textarea, #editor').forEach(editor=>{
                if (s.editor.fontFamily) editor.style.fontFamily = s.editor.fontFamily + ", monospace";
                if (s.editor.fontSize) editor.style.fontSize = s.editor.fontSize + 'px';
                if (s.editor.color) editor.style.color = s.editor.color;
                if (s.editor.bg) editor.style.backgroundColor = s.editor.bg;
            });
            // Ensure CodeMirror and its internals use the same background to avoid banding
            try{
                const pane = document.getElementById('editor-pane');
                if (pane && s.editor.bg){
                    pane.style.backgroundColor = s.editor.bg;
                    pane.style.setProperty('--editor-bg', s.editor.bg);
                }
                // If CodeMirror instances exist, refresh to repaint with new bg
                if (window.tabs && Array.isArray(tabs)){
                    tabs.forEach(t=>{ try{ if (t && t.cm && t.cm.refresh) t.cm.refresh(); }catch(_){ } });
                }
            }catch(_){ }
        }
        if (s.terminal) {
            const fam = s.terminal.fontFamily ? (s.terminal.fontFamily + ", monospace") : null;
            const size = s.terminal.fontSize ? (s.terminal.fontSize + 'px') : null;
            if (fam) { $('#terminal, #terminal .terminal').css('font-family', fam); }
            if (size) { $('#terminal, #terminal .terminal').css('font-size', size); }
            if (term) term.resize();
            try{ if (window.__terminalMode === 'side' && window.__adjustTerminalSideHeight) window.__adjustTerminalSideHeight(25); }catch(_){ }
        }
    }

    // Attach editor key handlers (Tab to indent/unindent instead of losing focus)
    function attachEditorKeyHandlers(textarea){
        if (!textarea || textarea.__tabHandled) return;
        textarea.addEventListener('keydown', function(e){
            if (e.key !== 'Tab') return;
            // Only handle Tab inside editor textareas
            e.preventDefault();
            const ta = e.target;
            const start = ta.selectionStart ?? 0;
            const end = ta.selectionEnd ?? 0;
            const val = ta.value || '';
            const scrollTop = ta.scrollTop;
            const scrollLeft = ta.scrollLeft;
            const tab = '\t';

            // Identify line range covering the selection
            const lineStart = val.lastIndexOf('\n', Math.max(0, start - 1)) + 1; // 0 if none found
            const lineEndIdx = val.indexOf('\n', end);
            const blockEnd = (lineEndIdx === -1 ? val.length : lineEndIdx);
            const isMultiLine = (start !== end) && val.slice(start, end).includes('\n');

            if (!e.shiftKey){
                if (isMultiLine){
                    // Indent each line in selection
                    const block = val.slice(lineStart, end);
                    const lines = block.split('\n');
                    const indented = lines.map(l => tab + l).join('\n');
                    const newVal = val.slice(0, lineStart) + indented + val.slice(end);
                    const added = lines.length; // one tab per line
                    ta.value = newVal;
                    ta.selectionStart = start + 1; // first line gained 1
                    ta.selectionEnd = end + added;
                } else {
                    // Simple caret insertion
                    ta.value = val.slice(0, start) + tab + val.slice(end);
                    ta.selectionStart = ta.selectionEnd = start + 1;
                }
            } else {
                // Shift+Tab: unindent
                const block = val.slice(lineStart, end);
                const lines = block.split('\n');
                let removedFirst = 0;
                let totalRemoved = 0;
                const unindented = lines.map((l, idx)=>{
                    let rem = 0;
                    if (l.startsWith('\t')) { l = l.slice(1); rem = 1; }
                    else if (l.startsWith('    ')) { l = l.slice(4); rem = 4; }
                    else if (l.startsWith('  ')) { l = l.slice(2); rem = 2; }
                    else if (l.startsWith(' ')) { l = l.slice(1); rem = 1; }
                    if (idx === 0) removedFirst = rem;
                    totalRemoved += rem;
                    return l;
                }).join('\n');
                const newVal = val.slice(0, lineStart) + unindented + val.slice(end);
                ta.value = newVal;
                // Adjust selection to account for removed indentation
                const newStart = start - removedFirst;
                const newEnd = end - totalRemoved;
                ta.selectionStart = Math.max(lineStart, newStart);
                ta.selectionEnd = Math.max(ta.selectionStart, newEnd);
            }

            // Restore scroll position to avoid jump
            ta.scrollTop = scrollTop;
            ta.scrollLeft = scrollLeft;
        }, true);
        // mark to avoid double wiring
        textarea.__tabHandled = true;
    }

    // Selection-aware Exec (F8) support
    function getEditorSelectionText(ed){
        const t = getActiveTab();
        if (t && t.cm){ try{ return t.cm.getSelection() || ''; }catch(_){ return ''; } }
        if (!ed) return '';
        try{
            const start = ed.selectionStart ?? 0;
            const end = ed.selectionEnd ?? 0;
            if (start === end) return '';
            return (ed.value || '').substring(Math.min(start,end), Math.max(start,end));
        }catch(_){ return ''; }
    }
    function isEditorFocused(ed){
        const t = getActiveTab();
        if (t && t.cm){ try{ return t.cm.hasFocus(); }catch(_){ } }
        return !!(ed && ed.classList && ed.classList.contains('editor-textarea') && document.activeElement === ed);
    }
    function updateExecButtonVisibility(){
        const btn = document.getElementById('btn-exec');
        if (!btn) return;
        const ed = getActiveEditor();
        // Keep button visible as long as there is a non-empty selection in the active editor,
        // even if the editor temporarily loses focus (e.g., when clicking the toolbar button).
        const hasSel = !!(ed && getEditorSelectionText(ed).trim().length > 0);
        btn.classList.toggle('d-none', !hasSel);
    }
    function attachEditorSelectionHandlers(textarea){
        if (!textarea || textarea.__execSelHandled) return;
        ['select','keyup','mouseup','input','focus','blur'].forEach(ev=>{
            textarea.addEventListener(ev, updateExecButtonVisibility, true);
        });
        textarea.__execSelHandled = true;
    }

    function openMenuById(id) {
        const trigger = document.getElementById(id);
        if (!trigger) return;
        const dd = bootstrap.Dropdown.getOrCreateInstance(trigger);
        dd.show();
        currentMenu = dd;
        // focus the trigger to direct subsequent keystrokes
        trigger.focus();
    }
    function closeCurrentMenu() {
        if (currentMenu) { currentMenu.hide(); currentMenu = null; }
    }

    // --- VFS integration and File menu actions ---
    function menuAction(action) {
        switch(action) {
            case 'file-new':
                onFileNew();
                break;
            case 'file-open':
                if (tabs.length >= MAX_TABS) { alert(`You have reached the tab limit (${MAX_TABS}). Close a tab to open another.`); }
                else { showOpenDialog(); }
                break;
            case 'file-save':
                onFileSave();
                break;
            case 'file-saveas':
                showSaveAsDialog();
                break;
            case 'file-close':
                onFileCloseTab();
                break;
            case 'proj-new':
                ProjectManager && ProjectManager.init && ProjectManager.init(vfs);
                ProjectManager.newProjectPrompt();
                break;
            case 'proj-open':
                ProjectManager && ProjectManager.init && ProjectManager.init(vfs);
                ProjectManager.openProjectPrompt();
                break;
            case 'proj-close':
                ProjectManager && ProjectManager.closeProject && ProjectManager.closeProject();
                break;
            case 'tool-1':
                alert('Menu item Tool 1 goes here');
                break;
            case 'tool-2':
                alert('Menu item Tool 2 goes here');
                break;
            case 'tool-3':
                alert('Menu item Tool 3 goes here');
                break;
            case 'help-reset':
                resetToDefaults();
                break;
            case 'about':
                const about = new bootstrap.Modal(document.getElementById('modalAbout'));
                about.show();
                break;
        }
    }

    function openEditor(suppressAutoload) {
        const pane = document.getElementById('editor-pane');
        const wasHidden = pane.classList.contains('d-none');
        pane.classList.remove('d-none');
        setNavHeight();
        // Optionally preload Hello World only on first reveal and only for first tab when empty
        if (wasHidden){
            const first = getTabById(0);
            if (!suppressAutoload && first && (first.textarea.value || '').trim() === ''){
                let code = loadCode();
                if (!code || code.trim().length === 0) {
                    const seedEl = document.getElementById('initial-editor-seed');
                    const seed = seedEl ? String(seedEl.textContent || '').trim() : '';
                    code = seed && seed.length ? seed : 'PRINT "Hello World"';
                }
                first.textarea.value = code; // only overwrite the first time we open in this session
                if (first.cm) try{ first.cm.setValue(code); }catch(_){}
                setTabTitle(0, 'Untitled', 'Untitled');
                // Treat initial content as clean
                first.savedContent = code;
                setTabDirty(first, false);
            }
            // Place caret on a new line at the end of the initial code for the first editor
            if (first && first.textarea){
                // Ensure trailing newline so caret lands on a blank new line
                if (!/\n$/.test(first.textarea.value)){
                    first.textarea.value += "\n";
                    if (first.cm) try{ first.cm.setValue(first.textarea.value); }catch(_){}
                }
                const len = first.textarea.value.length;
                try{
                    if (first.cm) first.cm.setCursor({ line: (first.cm.lineCount? first.cm.lineCount()-1 : 0), ch: 0 });
                    else { first.textarea.selectionStart = len; first.textarea.selectionEnd = len; }
                }catch(_){ /* ignore */ }
            }
        }
        const ed = getActiveEditor();
        if (ed) setTimeout(() => { try{ focusActiveEditor(); }catch(_){ } try{ attachEditorSelectionHandlers(ed); }catch(_){ } try{ updateExecButtonVisibility(); }catch(_){ } }, 0);
    }

    function closeEditor(clear) {
        if (clear) {
            setActiveCode(''); saveCode('');
        }
        document.getElementById('editor-pane').classList.add('d-none');
        setNavHeight();
        // reset current file state when closing
        currentFileName = null; currentFileReadOnly = false;
        // return focus to terminal
        if (term) setTimeout(() => term.focus(true), 0);
        try{ document.getElementById('btn-exec')?.classList.add('d-none'); }catch(_){ }
    }

    function preRunSyntaxCheck() {
        try{
            const t = getActiveTab();
            const mode = computeModeForName(t && t.fullName);
            if (mode !== 'yobasic') return true; // only check BASIC files
            if (!window.YoBasic || !YoBasic.checkSyntax) return true;
            const src = getActiveCode();
            const res = YoBasic.checkSyntax(src);
            if (res.ok) return true;
            const first = (res.errors||[])[0];
            if (t && t.cm && first){
                try{ t.cm.focus(); t.cm.setCursor({ line: Math.max(0, first.line|0), ch: Math.max(0, first.column|0) }); }catch(_){}
            }
            alert('Syntax error at line ' + ((first?.line ?? 0) + 1) + ', col ' + ((first?.column ?? 0) + 1) + '\n' + (first?.message || ''));
            return false;
        }catch(_){ return true; }
    }
    function runProgram() {
        if (!preRunSyntaxCheck()) return;
        // Pass VFS to interpreter before running
        if (basic) basic.vfs = vfs;
        const code = getActiveCode();
        if (!term) return;
        if (code.trim().length === 0) return;
        // Execute whole program using interpreter's runProgram to support control blocks
        basic.setTerm(term);
        try {
            const outLines = basic.runProgram(code);
            if (outLines && outLines.length) {
                outLines.forEach(l => { if (l && l.length) term.echo(l); });
            }
        } catch(e) {
            term.error(String(e && e.message ? e.message : e));
        }
        term.focus(true);
    }

    function execSelection(){
        // Execute only the selected portion of the code in the active editor
        if (!term || !basic) return;
        const ed = getActiveEditor();
        const sel = getEditorSelectionText(ed);
        if (!sel || sel.trim().length === 0) { updateExecButtonVisibility(); return; }
        // Provide VFS and terminal
        basic.vfs = vfs;
        basic.setTerm(term);
        try{
            const outLines = basic.runProgram(sel);
            if (outLines && outLines.length){ outLines.forEach(l=>{ if (l && l.length) term.echo(l); }); }
        }catch(e){
            term.error(String(e && e.message ? e.message : e));
        }
        term.focus(true);
    }

    function toggleDebug() {
        debugOn = !debugOn;
        const cmd = debugOn ? 'DEBUGON' : 'DEBUGOFF';
        term.exec(cmd);
    }
    function toggleClear() {
        const cmd = 'clear';
        term.exec(cmd);
    }

    // Wire DOM
    $(function(){
        // Splash screen control: min 3s, max 10s, hide when Supabase init/files loaded
        (function(){
            const overlay = document.getElementById('splash-overlay');
            if (!overlay) return; // nothing to do
            let hidden = false;
            function hideSplash(){
                if (hidden) return; hidden = true;
                overlay.style.display = 'none';
            }
            const start = Date.now();
            let minElapsed = false;
            setTimeout(function(){ minElapsed = true; if (window.__supabaseInitDone__) hideSplash(); }, 3000);
            setTimeout(function(){ hideSplash(); }, 10000);
            window.__splashReady__ = function(){ window.__supabaseInitDone__ = true; if (minElapsed) hideSplash(); };
        })();
        // Instantiate VFS and expose globally
        vfs = new VirtualFileSystem({ localStorageKey: 'yobasic.vfs' });
        vfs.loadFromLocalStorage();
        window.__vfsInstance__ = vfs;
        // Apply active theme or default (YoBASIC Dark) as early as possible
        (async function(){ try{ await ThemeManager.applyActiveOrDefault(); }catch(_){ } })();
        // Set up Supabase-backed providers
        (async ()=>{
            try{
                // Attempt to initialize Supabase (will noop if not configured)
                await getSupabase();
                const examplesProvider = new SupabaseExamplesProvider();
                const sharedProvider = new SupabaseSharedProvider(Identity);
                vfs.setProviders({ examples: examplesProvider, shared: sharedProvider });
                // Kick off initial loads so UI has data-ready signal
                try { await examplesProvider.listFiles(); } catch(e) { /* ignore */ }
                try { await sharedProvider.listOwners(); } catch(e) { /* ignore */ }
                await Identity.initializeFromSession();
                updateIdentityUi();
                // Initialize Chat
                if (window.Chat && Chat.init) await Chat.init();
                // After providers are ready, try loading sharedProject from URL
                try{ await tryLoadSharedProjectFromUrl(); }catch(err){ console.warn('sharedProject load failed', err); }
            }catch(e){ console.warn('[YoBASIC] Supabase init failed', e); }
            finally{ try{ window.__splashReady__ && window.__splashReady__(); }catch(_){} }
        })();

        // Host bridge (Phase 3 addendum)
        window.YoBasicHost = window.YoBasicHost || {
            showModal: function(html){
                // Create/reuse a bootstrap modal container
                let host = document.getElementById('modalHost');
                if (!host){
                    host = document.createElement('div');
                    host.id = 'modalHost';
                    host.className = 'modal fade';
                    host.tabIndex = -1;
                    host.innerHTML = [
                        '<div class="modal-dialog modal-lg modal-dialog-centered">',
                        '  <div class="modal-content bg-dark text-light">',
                        '    <div class="modal-header">',
                        '      <h5 class="modal-title">View</h5>',
                        '      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>',
                        '    </div>',
                        '    <div class="modal-body"><div id="modalHostBody"></div></div>',
                        '    <div class="modal-footer">',
                        '      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>',
                        '    </div>',
                        '  </div>',
                        '</div>'
                    ].join('');
                    document.body.appendChild(host);
                }
                const body = host.querySelector('#modalHostBody');
                if (body){ body.innerHTML = String(html || ''); }
                // Bind click handlers: id -> id_click
                try{
                    const container = body || host;
                    const clickable = container.querySelectorAll('[id]');
                    clickable.forEach(el=>{
                        const id = el.id;
                        if (!id) return;
                        const handlerName = (id + '_click').toLowerCase();
                        el.addEventListener('click', function(){
                            try{
                                if (window.ProjectManager && typeof ProjectManager.callAny === 'function'){
                                    ProjectManager.callAny(handlerName, []);
                                } else {
                                    console.warn('[YoBASIC] ProjectManager not ready for handler', handlerName);
                                }
                            }catch(e){ console.warn('[YoBASIC] handler error', handlerName, e); }
                        });
                    });
                }catch(e){ console.warn('Bind handlers failed', e); }
                const modal = bootstrap.Modal.getOrCreateInstance(host);
                modal.show();
                return '';
            }
        };
        function hostReadFile(path){
            const p = String(path||'');
            const absPrefixes = ['projects/','shared/','examples/','data/','demo/','/'];
            let full = p;
            if (!absPrefixes.some(pre=>p.toLowerCase().startsWith(pre))){
                // Resolve relative to current project if available
                const proj = (window.ProjectManager && ProjectManager.getCurrentProjectName && ProjectManager.getCurrentProjectName()) || null;
                if (proj){
                    full = `projects/${proj}/${p}`;
                } else {
                    // No project context yet; return empty per addendum option
                    return '';
                }
            }
            // Use synchronous VFS getFile when possible
            const f = vfs && vfs.getFile ? vfs.getFile(full) : null;
            if (f && typeof f.content === 'string') return f.content;
            // Fallback to data read for data/
            if (vfs && full.toLowerCase().startsWith('data/')){
                const d = vfs.readData(full);
                return d != null ? String(d) : '';
            }
            return '';
        }
        function hostExtern(name, args){
            try{
                const fn = window.YoBasicHost && window.YoBasicHost[name];
                if (typeof fn === 'function'){
                    const res = fn.apply(window.YoBasicHost, args || []);
                    return (typeof res === 'string') ? res : '';
                }
                console.warn('[YoBASIC] Unknown host method', name);
                return '';
            }catch(e){ console.warn('[YoBASIC] hostExtern error', e); return ''; }
        }
        function hostCallModule(moduleName, memberName, args, interpreter){
            const mod = String(moduleName||'').toUpperCase();
            let mem = String(memberName||'').toUpperCase();
            // Strip BASIC type suffixes for module member lookup
            mem = mem.replace(/[\$%]$/, '');

            // System modules (UI)
            if (mod === 'UI' && window.YoBasicUI) {
                if (typeof YoBasicUI[mem] === 'function') {
                    if (mem === 'SHOW' || mem === 'ON') {
                        return YoBasicUI[mem](interpreter, ...args);
                    }
                    return YoBasicUI[mem](...args);
                }
            }

            // Delegate dotted calls to the current project's modules when available
            try{
                if (window.ProjectManager && typeof ProjectManager.callModule === 'function' && ProjectManager.getCurrentProjectName && ProjectManager.getCurrentProjectName()){
                    return ProjectManager.callModule(moduleName, memberName, args || [], interpreter);
                }
            }catch(e){ throw e; }
            throw new Error('Unknown module: ' + moduleName);
        }

        // Initialize terminal in dedicated div
        basic = new BasicInterpreter({ term: null, autoEcho: false, debug: false, vfs, hostReadFile, hostExtern, hostCallModule });
        term = $('#terminal').terminal(function(command) {
            if (command !== '') {
                try {
                    basic.setTerm(term);
                    var out = basic.lineExecute(command);
                    if (out) {
                        String(out).split(/\n/).forEach(line => { if (line.length) this.echo(line); });
                    }
                } catch(e) {
                    this.error(new String(e));
                }
            }
        }, {
            greetings: 'üå±YoBASIC v1.0 by Blackrush, LLC\nCopyright (C) 1979-2026\nPress [F6] to toggle terminal\n\nTRACE is OFF (TROFF).',
            name: 'js_demo',
            prompt: "\nOK\n\n"
        });
        window.term = term;

        // --- Terminal Positioning State Machine ---
        (function(){
            const CENTER_HOST = document.getElementById('terminal');
            const SIDE_CONTAINER = document.getElementById('left-terminal-host');
            const SIDE_HOST = document.getElementById('terminal-side-host');
            const DIALOG = document.getElementById('terminal-dialog');
            const DIALOG_HOST = document.getElementById('terminal-dialog-host');
            const toolbar = document.getElementById('terminal-toolbar');
            const btnSide = document.getElementById('tt-side');
            const btnCenter = document.getElementById('tt-center');
            const btnDialog = document.getElementById('tt-dialog');
            const btnPin = document.getElementById('tt-pin');

            // Public flags
            window.__terminalMode = window.__terminalMode || 'center';
            window.__terminalLastDocked = window.__terminalLastDocked || 'center';
            let dialogDragging = false; let dragDx = 0, dragDy = 0;

            function moveNodeToHost(node, host){ if (!node || !host) return; host.appendChild(node); }
            function getTermLineHeightPx(){
                // jQuery Terminal uses CSS variable --size for font-size. Read computed line height.
                try{
                    const el = CENTER_HOST.querySelector('.terminal') || CENTER_HOST;
                    const style = window.getComputedStyle(el);
                    const lh = parseFloat(style.lineHeight);
                    if (!isNaN(lh)) return lh;
                }catch(_){ }
                // Fallback approximate
                return 18;
            }
            function adjustSideHeight(lines){
                const L = Math.max(10, lines|0);
                const h = Math.round(getTermLineHeightPx() * L + 8); // padding allowance
                SIDE_HOST.style.height = h + 'px';
                try{ if (term && term.resize) term.resize(); }catch(_){ }
            }
            window.__adjustTerminalSideHeight = adjustSideHeight;
            function collapseLeftAccordionAll(){
                try{
                    const acc = document.getElementById('leftAccordion'); if (!acc) return;
                    acc.querySelectorAll('.accordion-collapse.show').forEach(el=>{
                        const i = bootstrap.Collapse.getOrCreateInstance(el, { toggle: false }); i.hide();
                    });
                }catch(_){ }
            }
            function openLeftDrawerIfNeeded(){ try{ if (!DRAWERS.leftOpen) toggleLeftDrawer(true); }catch(_){ } }
            function updateToolbarVisibility(){ try{ toolbar.style.display = (window.__terminalMode === 'dialog') ? 'none' : ''; }catch(_){ }}

            window.setTerminalMode = function(mode){
                const m = String(mode||'center');
                if (m === window.__terminalMode) return;
                if (window.__terminalMode === 'dialog' && m !== 'dialog'){
                    // coming from dialog ‚Üí remember lastDocked already stored
                }
                if (m === 'dialog'){
                    window.__terminalLastDocked = (window.__terminalMode === 'side') ? 'side' : 'center';
                    // Move terminal into dialog host and show dialog
                    moveNodeToHost(CENTER_HOST, DIALOG_HOST);
                    DIALOG.style.display = 'block';
                    // Hide side container when entering dialog
                    SIDE_CONTAINER.style.display = 'none';
                } else if (m === 'side'){
                    DIALOG.style.display = 'none';
                    // Explicitly show side container (override CSS display:none)
                    SIDE_CONTAINER.style.display = 'block';
                    openLeftDrawerIfNeeded();
                    collapseLeftAccordionAll();
                    // Remember previous mode to restore when accordion expands
                    if (window.__terminalMode !== 'dialog') window.__terminalPrevBeforeSide = window.__terminalMode;
                    // Ensure the DOM node we move is the outer #terminal element
                    moveNodeToHost(CENTER_HOST, SIDE_HOST);
                    adjustSideHeight(25);
                } else { // center
                    DIALOG.style.display = 'none';
                    // Hide side container when in center mode
                    SIDE_CONTAINER.style.display = 'none';
                    moveNodeToHost(CENTER_HOST, document.getElementById('terminal-pane'));
                }
                window.__terminalMode = m;
                setNavHeight();
                updateToolbarVisibility();
            };

            // Toolbar controls
            if (btnSide) btnSide.addEventListener('click', function(){ if (window.__terminalMode !== 'dialog') setTerminalMode('side'); });
            if (btnCenter) btnCenter.addEventListener('click', function(){ if (window.__terminalMode !== 'dialog') setTerminalMode('center'); });
            if (btnDialog) btnDialog.addEventListener('click', function(){ setTerminalMode('dialog'); });
            if (btnPin) btnPin.addEventListener('click', function(){ /* reserved */ });

            // Double-click behaviors
            CENTER_HOST.addEventListener('dblclick', function(){ if (window.__terminalMode !== 'dialog') setTerminalMode('dialog'); });
            DIALOG.addEventListener('dblclick', function(){ if (window.__terminalMode === 'dialog'){ setTerminalMode(window.__terminalLastDocked || 'center'); }});

            // Make dialog draggable via header
            const header = DIALOG.querySelector('.td-header');
            header.addEventListener('mousedown', function(e){ dialogDragging = true; const r = DIALOG.getBoundingClientRect(); dragDx = e.clientX - r.left; dragDy = e.clientY - r.top; e.preventDefault(); });
            window.addEventListener('mousemove', function(e){ if (!dialogDragging) return; DIALOG.style.left = Math.max(0, e.clientX - dragDx) + 'px'; DIALOG.style.top = Math.max(0, e.clientY - dragDy) + 'px'; });
            window.addEventListener('mouseup', function(){ dialogDragging = false; });

            // Accordion expand ‚Üí if currently side and not dialog, revert to center
            try{
                document.getElementById('leftAccordion').addEventListener('show.bs.collapse', function(){ if (window.__terminalMode === 'side'){ setTerminalMode(window.__terminalPrevBeforeSide || 'center'); } });
            }catch(_){ }

            // Recalculate heights when fonts change
            window.addEventListener('resize', function(){ if (window.__terminalMode==='side') adjustSideHeight(25); });

            // Observe container size changes (dialog/side) and resize terminal
            try{
                if (window.ResizeObserver){
                    const ro = new ResizeObserver(function(){ try{ term && term.resize && term.resize(); }catch(_){ } });
                    ro.observe(DIALOG);
                    ro.observe(SIDE_HOST);
                }
            }catch(_){ }

            // Initial
            updateToolbarVisibility();
        })();

        // Height + focus
        setNavHeight();
        window.addEventListener('resize', setNavHeight);
        // Do not focus terminal by default; the editor will grab initial focus

        // Restore settings (may be overridden by active theme)
        const settings = loadSettings();
        // populate settings UI
        $('#editor-font').val(settings.editor?.fontFamily || 'Courier New');
        $('#editor-size').val(settings.editor?.fontSize || 16);
        $('#editor-color').val(settings.editor?.color || getComputedStyle(document.documentElement).getPropertyValue('--editor-fg').trim() || '#e6f0ff');
        $('#editor-bg').val(settings.editor?.bg || getComputedStyle(document.documentElement).getPropertyValue('--editor-bg').trim() || '#031634');
        $('#terminal-font').val(settings.terminal?.fontFamily || 'Courier New');
        $('#terminal-size').val(settings.terminal?.fontSize || 16);
        applySettings(settings);

        // Autosave editor content
        buildInitialTabUi();
        // Show editor and focus first tab on initial load
        try { openEditor(false); activateTab(0); } catch(_){}
        $('#editor').on('input', function(){ saveCode(this.value); });

        // Menu item clicks
        $('.dropdown-item').on('click', function(e){
            const action = this.dataset.action;
            if (action) {
                e.preventDefault();
                closeCurrentMenu();
                menuAction(action);
            } else {
                // For links without data-action, let the browser handle it, but close the menu
                closeCurrentMenu();
            }
        });

        // Open dialog interactions
        $('#open-folders').on('click', '.list-group-item[data-folder]', function(){
            $('#open-folders .list-group-item').removeClass('active');
            $(this).addClass('active');
            renderOpenFiles($(this).data('folder'));
        });
        $('#open-files').on('click', '.list-group-item', function(){
            $('#open-files .list-group-item').removeClass('active');
            $(this).addClass('active');
            $('#btn-open-ok').prop('disabled', false);
        });
        $('#open-files').on('dblclick', '.list-group-item', function(){ $('#btn-open-ok').trigger('click'); });
        $('#btn-open-ok').on('click', async function(){
            const $sel = $('#open-files .list-group-item.active');
            if ($sel.length === 0) return;
            if (tabs.length >= MAX_TABS){ alert(`You have reached the tab limit (${MAX_TABS}). Close a tab to open another.`); return; }
            const fullName = $sel.data('fullname');
            const isRemote = /^examples\//i.test(fullName) || /^shared\//i.test(fullName) || /^demo\//i.test(fullName);
            const file = isRemote ? (await vfs.getFileAsync(fullName)) : vfs.getFile(fullName);
            if (!file) return;
            // If already open (same full path), just activate that tab
            const existing = findTabByFullName(file.name);
            if (existing){ activateTab(existing.id); bootstrap.Modal.getOrCreateInstance(document.getElementById('modalOpen')).hide(); return; }
            const displayName = fullName.includes('/') ? fullName.split('/').pop() : fullName;
            createNewTab({
                content: file.content || '',
                fullName: file.name,
                readOnly: !!file.readOnly,
                displayName
            });
            bootstrap.Modal.getOrCreateInstance(document.getElementById('modalOpen')).hide();
        });

        // Save As dialog interactions
        $('#save-folders').on('click', '.list-group-item', function(){
            // Only Root enabled for saving program files now
            $('#save-folders .list-group-item').removeClass('active');
            $(this).addClass('active');
            renderSaveFiles($(this).data('folder'));
        });
        $('#save-files').on('click', '.list-group-item', function(){
            $('#save-files .list-group-item').removeClass('active');
            $(this).addClass('active');
            const name = $(this).data('fullname');
            const folderBtn = document.querySelector('#save-folders .list-group-item.active');
            const folder = folderBtn ? folderBtn.getAttribute('data-folder') : 'Root';
            if (folder === 'projects'){
                const proj = (window.ProjectManager && ProjectManager.getCurrentProjectName && ProjectManager.getCurrentProjectName()) || null;
                const prefix = proj ? (`projects/${proj}/`) : null;
                if (proj && String(name).toLowerCase().startsWith(prefix.toLowerCase())){
                    $('#saveas-name').val(name.slice(prefix.length));
                    return;
                }
            }
            $('#saveas-name').val(name);
        });
        $('#btn-saveas-ok').on('click', function(){ doSaveAs(); });

        // Toolbar buttons
        $('#btn-run').on('click', function(){ runProgram(); });
        $('#btn-exec').on('click', function(){ execSelection(); });
        $('#btn-bug').on('click', function(){ toggleDebug(); });
        $('#btn-clear').on('click', function(){ toggleClear(); });
        $('#btn-build').on('click', async function(){
            try{
                ProjectManager && ProjectManager.init && ProjectManager.init(vfs);
                await ProjectManager.buildCurrent();
            }catch(e){ alert(String(e && e.message ? e.message : e)); }
        });
        $('#btn-settings').on('click', function(){ new bootstrap.Modal(document.getElementById('modalSettings')).show(); });

        // Save settings
        $('#btn-save-settings').on('click', function(){
            const s = {
                editor: {
                    fontFamily: $('#editor-font').val(),
                    fontSize: parseInt($('#editor-size').val(), 10) || 16,
                    color: $('#editor-color').val(),
                    bg: $('#editor-bg').val()
                },
                terminal: {
                    fontFamily: $('#terminal-font').val(),
                    fontSize: parseInt($('#terminal-size').val(), 10) || 16
                }
            };
            saveSettings(s);
            applySettings(s);
        });

        // Colors tab wiring
        (function(){
            function hex(val){
                const s = String(val || '').trim();
                if (/^#?[0-9a-f]{6}$/i.test(s)) return s.startsWith('#') ? s : ('#'+s);
                return s;
            }
            function fillInputsFromTheme(th){
                const v = (th && th.variables) || {};
                $('#color-app-bg').val(hex(v['--app-bg'] || getCss('--app-bg') || '#0b1b3b'));
                $('#color-app-fg').val(hex(v['--app-fg'] || getCss('--app-fg') || '#e6f0ff'));
                $('#color-accent').val(hex(v['--accent'] || getCss('--accent') || '#FF6600'));
                $('#color-border').val(hex(v['--border'] || getCss('--border') || '#1e2a55'));
                $('#color-editor-bg').val(hex(v['--editor-bg'] || getCss('--editor-bg') || '#031634'));
                $('#color-editor-fg').val(hex(v['--editor-fg'] || getCss('--editor-fg') || '#e6f0ff'));
                $('#color-terminal-bg').val(hex(v['--terminal-bg'] || getCss('--terminal-bg') || '#001a33'));
                $('#color-terminal-fg').val(hex(v['--terminal-fg'] || getCss('--terminal-fg') || '#e6f0ff'));
            }
            function getCss(name){ try{ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }catch(_){ return ''; } }
            function makeDraftFromInputs(){
                const base = window.__activeTheme || { id:'custom', name:'Custom', version:1, variables:{}, editor:{}, terminal:{} };
                const draft = JSON.parse(JSON.stringify(base));
                draft.variables = Object.assign({}, draft.variables, {
                    '--app-bg': $('#color-app-bg').val(),
                    '--app-fg': $('#color-app-fg').val(),
                    '--accent': $('#color-accent').val(),
                    '--border': $('#color-border').val(),
                    '--editor-bg': $('#color-editor-bg').val(),
                    '--editor-fg': $('#color-editor-fg').val(),
                    '--terminal-bg': $('#color-terminal-bg').val(),
                    '--terminal-fg': $('#color-terminal-fg').val()
                });
                return draft;
            }
            // Populate from current theme when modal opens
            document.getElementById('modalSettings').addEventListener('shown.bs.modal', function(){
                fillInputsFromTheme(window.__activeTheme);
            });
            // Theme selection
            $('#theme-select').on('change', async function(){
                const ref = $(this).val();
                try{ const th = await ThemeManager.loadRef(ref); if (th){ ThemeManager.apply(th, String(ref)); fillInputsFromTheme(th); } }
                catch(e){ alert(String(e && e.message ? e.message : e)); }
            });
            // Apply
            $('#btn-theme-apply').on('click', function(){
                const draft = makeDraftFromInputs();
                window.__themeDraft = draft;
                ThemeManager.apply(draft, null);
            });
            // Save As (Local)
            $('#btn-theme-save-local').on('click', function(){
                const nm = prompt('Save theme as (name):', window.__activeTheme?.name || 'My Theme');
                if (!nm) return;
                try{ ThemeManager.saveLocal(nm, makeDraftFromInputs()); alert('Saved locally as "' + nm + '"'); }
                catch(e){ alert(String(e && e.message ? e.message : e)); }
            });
            // Save to Supabase (Shared)
            function updateThemeSharedButton(){
                const me = (window.Identity && Identity.getCurrentUser && Identity.getCurrentUser()) || null;
                $('#btn-theme-save-shared').prop('disabled', !me);
            }
            updateThemeSharedButton();
            $('#btn-theme-save-shared').on('click', async function(){
                const me = (window.Identity && Identity.getCurrentUser && Identity.getCurrentUser()) || null;
                if (!me){ alert('Log in to save to Supabase.'); return; }
                const nm = prompt('Save shared theme name:', window.__activeTheme?.name || 'My Theme');
                if (!nm) return;
                try{ await ThemeManager.saveShared(nm, makeDraftFromInputs()); alert('Saved to shared/' + me.username + '/themes/' + nm + '.json'); }
                catch(e){ alert(String(e && e.message ? e.message : e)); }
            });
            // Export
            $('#btn-theme-export').on('click', async function(){
                const json = ThemeManager.exportJson(makeDraftFromInputs());
                try{
                    await navigator.clipboard.writeText(json);
                    alert('Theme JSON copied to clipboard.');
                }catch(_){
                    // Fallback: show prompt
                    prompt('Copy theme JSON:', json);
                }
            });
            // Import
            $('#btn-theme-import').on('click', function(){
                const raw = prompt('Paste theme JSON:');
                if (!raw) return;
                const th = ThemeManager.importJson(raw);
                if (!th){ alert('Invalid JSON.'); return; }
                ThemeManager.apply(th, null);
                fillInputsFromTheme(th);
            });
            // Reset to default
            $('#btn-theme-reset').on('click', async function(){
                try{
                    const th = await ThemeManager.loadRef('themes/YoBASIC Dark.json');
                    if (th){ ThemeManager.apply(th, 'themes/YoBASIC Dark.json'); fillInputsFromTheme(th); $('#theme-select').val('themes/YoBASIC Dark.json'); }
                }catch(e){ alert(String(e && e.message ? e.message : e)); }
            });
            // Keep shared button in sync with identity changes when modal opens
            document.getElementById('modalIdentity')?.addEventListener('hidden.bs.modal', updateThemeSharedButton);
        })();

        // Identity button
        $('#btn-identity').on('click', function(){
            updateIdentityUi();
            new bootstrap.Modal(document.getElementById('modalIdentity')).show();
        });
        // Identity actions
        $('#btn-login').on('click', async function(){
            const u = $('#login-username').val().trim();
            const p = $('#login-password').val();
            try{
                await Identity.login(u, p);
                updateIdentityUi();
                bootstrap.Modal.getOrCreateInstance(document.getElementById('modalIdentity')).hide();
                term && term.echo && term.echo('[Logged in] ' + Identity.getCurrentUser().username);
            }catch(e){ alert(String(e.message || e)); }
        });
        $('#btn-signup').on('click', async function(){
            const u = $('#signup-username').val().trim();
            const e = $('#signup-email').val().trim();
            const p = $('#signup-password').val();
            try{
                const res = await Identity.signup(u, e, p);
                if (res && res.needsConfirmation){
                    alert('Check your email (' + e + ') and confirm your address, then return here to Log In.');
                    // Switch to Login tab and prefill with email
                    const loginTabBtn = document.getElementById('tab-login-tab');
                    if (loginTabBtn){
                        // Bootstrap 5 Tab API
                        if (bootstrap && bootstrap.Tab){ bootstrap.Tab.getOrCreateInstance(loginTabBtn).show(); }
                        else { loginTabBtn.click(); }
                    }
                    $('#login-username').val(e);
                    return;
                }
                updateIdentityUi();
                bootstrap.Modal.getOrCreateInstance(document.getElementById('modalIdentity')).hide();
                term && term.echo && term.echo('[Identity created] ' + (Identity.getCurrentUser()?.username || u));
            }catch(e){ alert(String(e.message || e)); }
        });
        $('#btn-logout').on('click', async function(){
            try{ await Identity.logout(); updateIdentityUi(); }
            catch(e){}
            bootstrap.Modal.getOrCreateInstance(document.getElementById('modalIdentity')).hide();
            term && term.echo && term.echo('[Logged out]');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e){
            // Intercept F5 to prevent accidental page refresh
            if (e.key === 'F5') { e.preventDefault(); return; }
            // Open menus with Alt+F/T/H
            if (e.altKey && !e.ctrlKey && !e.metaKey) {
                const k = e.key.toLowerCase();
                if (k === 'f') { e.preventDefault(); openMenuById('menu-file'); return; }
                if (k === 't') { e.preventDefault(); openMenuById('menu-tools'); return; }
                if (k === 'h') { e.preventDefault(); openMenuById('menu-help'); return; }
            }
            // Ctrl+S shortcut to Save
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); onFileSave(); return; }
            // If a dropdown is open, handle hotkeys for items
            if (currentMenu) {
                const k = e.key.toLowerCase();
                if (/^[a-z0-9]$/.test(k)) {
                    e.preventDefault();
                    const trigger = currentMenu._element; // anchor
                    const menuId = trigger.getAttribute('aria-controls') || trigger.getAttribute('data-bs-target');
                    // find menu via nextElementSibling (Bootstrap renders immediately after trigger)
                    const menu = trigger.nextElementSibling?.classList.contains('dropdown-menu') ? trigger.nextElementSibling : null;
                    if (menu) {
                        const item = menu.querySelector(`[data-key="${k}"]`);
                        if (item) { item.click(); }
                    }
                }
                if (e.key === 'Escape') { closeCurrentMenu(); }
            }
        }, true);
    });

    function updateIdentityUi(){
        const me = Identity.getCurrentUser && Identity.getCurrentUser();
        if (window.Chat && Chat.refresh) Chat.refresh();
        if (me){
            $('#identity-status').text(`You are logged in as ${me.username}.`);
            $('#identity-forms').addClass('d-none');
            $('#identity-loggedin').removeClass('d-none');
            $('#whoami').text(me.username);
            $('#identity-label').text(me.username);
            // Enable Shared in Save As
            $('#save-folders [data-folder="shared"]').prop('disabled', false);
        } else {
            $('#identity-status').text('You are not logged in.');
            $('#identity-forms').removeClass('d-none');
            $('#identity-loggedin').addClass('d-none');
            $('#identity-label').text('Login');
            // Disable Shared in Save As (still visible for info)
            $('#save-folders [data-folder="shared"]').prop('disabled', false); // allow viewing guidance
        }
    }

    // --- Dialog helpers and file operations ---
    function labelForFile(f, opts){
        const name = String(f.name);
        const lower = name.toLowerCase();
        const ctx = opts || {};
        const ro = f.readOnly ? ' [RO]' : '';
        // Prefer showing a relative path within the selected namespace
        if (ctx.folder === 'projects'){
            // Show path after projects/<ProjectName>/
            const idx = lower.indexOf('projects/');
            if (idx === 0){
                const rest = name.slice(('projects/').length);
                const slash = rest.indexOf('/');
                if (slash >= 0){ return rest.slice(slash+1) + ro; }
                return rest + ro;
            }
        }
        if (ctx.folder === 'shared' && ctx.owner){
            const prefix = `shared/${ctx.owner}/`;
            if (lower.startsWith(prefix.toLowerCase())){
                return name.slice(prefix.length) + ro;
            }
        }
        if (lower.startsWith('shared/')){
            // default for shared without owner context: show owner/path
            return name.slice('shared/'.length) + ro;
        }
        if (lower.startsWith('examples/')){
            return name.slice('examples/'.length) + ro;
        }
        if (lower.startsWith('demo/')){
            return name.slice('demo/'.length) + ro;
        }
        if (lower.startsWith('data/')){
            return name.slice('data/'.length) + ro;
        }
        // Root fallback: show full relative path for Root so nested paths are visible
        if (ctx.folder === 'Root'){
            return name + ro;
        }
        // default: base name
        return (name.includes('/') ? name.split('/').pop() : name) + ro;
    }
    async function renderOpenFiles(folder){
        const list = $('#open-files').empty();
        if (folder === 'shared'){
            // show owners list in left column under folders
            await renderSharedOwners();
            // By default, do not list files until an owner is clicked
            list.append('<div class="list-group-item list-group-item-dark disabled">Select a user from the Shared list to view files.</div>');
            $('#btn-open-ok').prop('disabled', true);
            return;
        }
        if (folder === 'projects'){
            await renderProjectsPanel();
            list.append('<div class="list-group-item list-group-item-dark disabled">Select a project to view files.</div>');
            $('#btn-open-ok').prop('disabled', true);
            return;
        }
        // clear side panels when not browsing shared/projects
        if (folder !== 'shared'){ $('#open-shared-owners').empty(); }
        if (folder !== 'projects'){ $('#open-projects').empty(); }
        const isRemote = (folder === 'examples' || folder === 'demo');
        const files = isRemote ? (await vfs.listByFolderAsync(folder)) : vfs.listByFolder(folder);
        list.empty();
        files.forEach(f => {
            const disabled = (folder === 'data' && f.kind !== 'data') ? ' disabled' : '';
            const $item = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark${disabled}" data-fullname="${f.name}">${labelForFile(f, { folder })}</button>`);
            list.append($item);
        });
        $('#btn-open-ok').prop('disabled', true);
    }
    async function renderProjectsPanel(){
        const c = $('#open-projects').empty();
        const names = getLocalProjectNames();
        if (!names.length){ c.append('<div class="text-secondary small">No local projects.</div>'); return; }
        c.append('<div class="small text-secondary">Projects</div>');
        names.forEach(name=>{
            const btn = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-project="${name}">projects/${name}</button>`);
            btn.on('click', function(){
                $('#open-projects .list-group-item').removeClass('active');
                $(this).addClass('active');
                const prefix = `projects/${name}/`;
                const files = vfs.listFiles().filter(f=>f.name.toLowerCase().startsWith(prefix.toLowerCase()));
                const list = $('#open-files').empty();
                files.forEach(f=>{
                    const $item = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-fullname="${f.name}">${labelForFile(f, { folder: 'projects' })}</button>`);
                    list.append($item);
                });
                $('#btn-open-ok').prop('disabled', true);
            });
            c.append(btn);
        });
    }
    function getLocalProjectNames(){
        const files = vfs.listFiles();
        const set = new Set();
        files.forEach(f=>{
            const n = f.name;
            if (n.toLowerCase().startsWith('projects/')){
                const rest = n.slice(9);
                const idx = rest.indexOf('/');
                if (idx > 0) set.add(rest.slice(0, idx));
            }
        });
        return Array.from(set.values()).sort();
    }
    async function renderSharedOwners(){
        const c = $('#open-shared-owners').empty();
        const prov = vfs && vfs.providers && vfs.providers.shared;
        if (!prov){ c.append('<div class="text-secondary small">Shared disabled.</div>'); return; }
        const owners = await (prov.listOwners ? prov.listOwners() : []);
        if (!owners.length){ c.append('<div class="text-secondary small">No shared users yet.</div>'); return; }
        c.append('<div class="small text-secondary">Users</div>');
        owners.forEach(owner=>{
            const btn = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-owner="${owner}">shared/${owner}</button>`);
            btn.on('click', async function(){
                $('#open-folders .list-group-item').removeClass('active');
                $(this).addClass('active');
                const files = await prov.listFilesForOwner(owner);
                const list = $('#open-files').empty();
                files.forEach(f=>{
                    const $item = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-fullname="${f.name}">${labelForFile(f, { folder: 'shared', owner: owner })}</button>`);
                    list.append($item);
                });
                $('#btn-open-ok').prop('disabled', true);
            });
            c.append(btn);
        });
    }
    async function renderSaveFiles(folder){
        const list = $('#save-files').empty();
        const help = $('#modalSaveAs .form-text');
        if (folder === 'shared'){
            help.text('Save into your shared folder as <name>.BAS');
            const me = Identity.getCurrentUser && Identity.getCurrentUser();
            if (!me){ list.append('<div class="list-group-item list-group-item-dark disabled">Log in to save to your shared folder.</div>'); return; }
            // list my existing shared files
            const prov = vfs && vfs.providers && vfs.providers.shared;
            if (!prov){ list.append('<div class="list-group-item list-group-item-dark disabled">Shared is not available.</div>'); return; }
            const files = await prov.listFilesForOwner(me.username);
            files.forEach(f=>{
                const $item = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-fullname="${f.name}">${labelForFile(f, { folder: 'shared', owner: me.username })}</button>`);
                list.append($item);
            });
            return;
        }
        if (folder === 'projects'){
            const proj = (window.ProjectManager && ProjectManager.getCurrentProjectName && ProjectManager.getCurrentProjectName()) || null;
            if (!proj){ help.text('Open a project to save files into it.'); list.append('<div class="list-group-item list-group-item-dark disabled">No project open.</div>'); return; }
            help.text(`Saving into projects/${proj}/... Enter a relative path like Modules/NEW.BAS`);
            const prefix = `projects/${proj}/`;
            const files = vfs.listFiles().filter(f=>f.name.toLowerCase().startsWith(prefix.toLowerCase()));
            files.forEach(f=>{
                const $item = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-fullname="${f.name}">${labelForFile(f, { folder: 'projects' })}</button>`);
                list.append($item);
            });
            return;
        }
        // Root
        help.text('Programs are saved in Root as .BAS files. You can also use subfolders like chapter1/HELLO.BAS');
        const files = vfs.listByFolder('Root').filter(f=>f.kind==='program');
        files.forEach(f => {
            const $item = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-fullname="${f.name}">${labelForFile(f, { folder: 'Root' })}</button>`);
            list.append($item);
        });
    }
    function showOpenDialog(){
        renderOpenFiles('Root');
        const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('modalOpen'));
        m.show();
    }
    function showSaveAsDialog(){
        // Prefill with full suggested path (e.g., "
        // /HELLO.BAS") when saving to Root
        $('#saveas-name').val(currentFileName && !currentFileReadOnly ? currentFileName : '');
        renderSaveFiles('Root');
        const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('modalSaveAs'));
        m.show();
        setTimeout(()=>document.getElementById('saveas-name').focus(), 0);
    }
    function normalizeBasName(name){
        let n = String(name||'').trim();
        if (n.length === 0) return null;
        // Replace \ with /
        n = n.replace(/\\/g, '/');
        // Add .BAS only if no extension is present
        if (!/\.[a-zA-Z0-9]+$/i.test(n)) n += '.BAS';
        return n;
    }
    function onFileCloseTab(){
        closeTab(activeTabId);
    }
    function onFileNew(){
        if (tabs.length >= MAX_TABS){
            alert(`You have reached the tab limit (${MAX_TABS}). Close a tab to add another.`);
            return;
        }
        createNewTab({ content: '', displayName: 'Untitled' });
        const tab = getActiveTab();
        if (tab){ tab.fullName = null; tab.readOnly = false; }
        saveCode('');
    }
    async function onFileSave(){
        // Direct save if current file exists and is writable
        if (currentFileName && !currentFileReadOnly){
            const content = getActiveCode();
            const isBas = /\.bas$/i.test(currentFileName);
            if (/^shared\//i.test(currentFileName)){
                if (isBas) {
                    await vfs.writeProgramAsync(currentFileName, content);
                } else {
                    await vfs.writeFileAsync(currentFileName, content, 'data');
                }
            } else {
                if (isBas) {
                    vfs.writeProgram(currentFileName, content);
                } else {
                    vfs.writeFile(currentFileName, content, 'data');
                }
                vfs.saveToLocalStorage();
            }
            // keep tab title consistent
            const base = currentFileName.includes('/') ? currentFileName.split('/').pop() : currentFileName;
            setTabTitle(activeTabId, base, currentFileName);
            const t = getActiveTab(); if (t){ t.fullName = currentFileName; t.readOnly = false; t.savedContent = content; setTabDirty(t, false); }
            try{ refreshAndApplyMode(getActiveTab()); }catch(_){ }
            try{ await buildVfsTree(); }catch(_){ }
            term && term.echo && term.echo('[Saved] ' + currentFileName);
            return;
        }
        // Otherwise Save As
        showSaveAsDialog();
    }
    async function doSaveAs(){
        const folderBtn = document.querySelector('#save-folders .list-group-item.active');
        const folder = folderBtn ? folderBtn.getAttribute('data-folder') : 'Root';
        const nameInput = document.getElementById('saveas-name');
        const normalizedBase = normalizeBasName(nameInput.value);
        if (!normalizedBase){ alert('Please enter a file name.'); return; }
        let targetName = normalizedBase;
        if (folder === 'shared'){
            const me = Identity.getCurrentUser && Identity.getCurrentUser();
            if (!me){ alert('Log in to save to Shared.'); return; }
            targetName = `shared/${me.username}/${normalizedBase}`;
        } else if (folder === 'projects'){
            const proj = (window.ProjectManager && ProjectManager.getCurrentProjectName && ProjectManager.getCurrentProjectName()) || null;
            if (!proj){ alert('Open a project to save into it.'); return; }
            // Allow entering relative path like Menus/NEW.BAS, Modules/X.BAS, Views/Y.html
            const rel = nameInput.value.trim();
            if (!rel){ alert('Enter a relative path within the project, e.g., Modules/NEW.BAS'); return; }
            targetName = `projects/${proj}/${rel}`;
        } else if (folder !== 'Root'){
            alert('Choose Root, Projects, or Shared to save program files.');
            return;
        }
        // Check existing (local for Root/Projects, remote for Shared)
        let existing = null;
        if (/^shared\//i.test(targetName)){
            existing = await vfs.getFileAsync(targetName);
        } else {
            existing = vfs.getFile(targetName);
        }
        if (existing){
            if (existing.readOnly){ alert('This file is read-only. Use a different name.'); return; }
            if (!confirm('File already exists. Overwrite?')) return;
        }
        const content = getActiveCode();
        const isBas = /\.bas$/i.test(targetName);
        if (/^shared\//i.test(targetName)){
            if (isBas){
                await vfs.writeProgramAsync(targetName, content);
            } else {
                await vfs.writeFileAsync(targetName, content, 'data');
            }
            currentFileName = targetName; currentFileReadOnly = false;
        } else {
            if (isBas){ vfs.writeProgram(targetName, content); }
            else { vfs.writeFile(targetName, content, 'data'); }
            vfs.saveToLocalStorage();
            currentFileName = targetName; currentFileReadOnly = false;
        }
        // Update tab metadata and title/tooltip
        const base = targetName.includes('/') ? targetName.split('/').pop() : targetName;
        setTabTitle(activeTabId, base, targetName);
        const t = getActiveTab(); if (t){ t.fullName = targetName; t.readOnly = false; t.savedContent = content; setTabDirty(t, false); try{ refreshAndApplyMode(t); }catch(_){ } }
        try{ await buildVfsTree(); }catch(_){ }
        bootstrap.Modal.getOrCreateInstance(document.getElementById('modalSaveAs')).hide();
        term && term.echo && term.echo('[Saved] ' + targetName);
    }
    // --- Slide-out Drawers (Left: Files/Watch/Message, Right: Home docs) ---
    // Adjustable widths: tweak the CSS variables below or in the added <style> tag.
    const DRAWERS = {
        leftOpen: false,
        rightOpen: false
    };
    function isAnyModalOpen(){ return !!document.querySelector('.modal.show'); }
    function updateDrawerOffsets(){
        const root = document.documentElement;
        root.style.setProperty('--left-offset', DRAWERS.leftOpen ? 'var(--left-drawer-width)' : '0px');
        root.style.setProperty('--right-offset', DRAWERS.rightOpen ? 'var(--right-drawer-width)' : '0px');
    }
    function toggleLeftDrawer(force){
        const el = document.getElementById('left-drawer');
        if (!el) return;
        const open = (typeof force === 'boolean') ? force : !DRAWERS.leftOpen;
        DRAWERS.leftOpen = open;
        el.classList.toggle('open', open);
        document.getElementById('toggle-left-drawer')?.setAttribute('aria-expanded', String(open));
        updateDrawerOffsets();
        try{ updateTabsPad(); }catch(_){ }
    }
    function toggleRightDrawer(force){
        const el = document.getElementById('right-drawer');
        if (!el) return;
        const open = (typeof force === 'boolean') ? force : !DRAWERS.rightOpen;
        DRAWERS.rightOpen = open;
        el.classList.toggle('open', open);
        document.getElementById('toggle-right-drawer')?.setAttribute('aria-expanded', String(open));
        updateDrawerOffsets();
        try{ updateTabsPad(); }catch(_){ }
    }
    function closeDrawers(){ toggleLeftDrawer(false); toggleRightDrawer(false); }

    // --- VFS Tree (Files) ---
    function listLocalProjectNames(){
        const files = vfs.listFiles();
        const set = new Set();
        files.forEach(f=>{
            const n = f.name;
            if (n.toLowerCase().startsWith('projects/')){
                const rest = n.slice(9);
                const idx = rest.indexOf('/');
                if (idx > 0) set.add(rest.slice(0, idx));
            }
        });
        return Array.from(set.values()).sort();
    }
    function nestFiles(files, stripPrefix){
        const root = { dirs: {}, files: [] };
        files.forEach(f=>{
            let rest = f.name;
            if (stripPrefix && rest.toLowerCase().startsWith(stripPrefix.toLowerCase())){
                rest = rest.slice(stripPrefix.length);
            }
            const parts = rest.split('/');
            if (parts.length === 1){
                root.files.push({ file: f, label: parts[0] });
            } else {
                let cur = root;
                for (let i=0;i<parts.length-1;i++){
                    const seg = parts[i];
                    if (!cur.dirs[seg]) cur.dirs[seg] = { dirs:{}, files:[] };
                    cur = cur.dirs[seg];
                }
                cur.files.push({ file: f, label: parts[parts.length-1] });
            }
        });
        return root;
    }
    function renderTreeNode(name, data, basePath){
        const li = document.createElement('li'); li.className = 'vfs-node folder';
        const head = document.createElement('div'); head.className = 'vfs-row';
        const caret = document.createElement('i'); caret.className = 'bi bi-chevron-right vfs-caret';
        const label = document.createElement('span'); label.className = 'vfs-label'; label.textContent = name;
        head.appendChild(caret); head.appendChild(label);
        li.appendChild(head);
        const ul = document.createElement('ul'); ul.className = 'vfs-children'; ul.style.display = 'none';
        // subdirs
        Object.keys(data.dirs).sort().forEach(dn=>{
            const child = renderTreeNode(dn, data.dirs[dn], basePath ? (basePath + dn + '/') : (dn + '/'));
            ul.appendChild(child);
        });
        // files
        data.files.sort((a,b)=>a.label.localeCompare(b.label)).forEach(it=>{
            const fli = document.createElement('li'); fli.className='vfs-node file';
            const row = document.createElement('div'); row.className='vfs-row';
            const icon = document.createElement('i'); icon.className='bi bi-file-earmark-text';
            const lab = document.createElement('span'); lab.className='vfs-label'; lab.textContent = it.label;
            row.appendChild(icon); row.appendChild(lab); fli.appendChild(row);
            fli.dataset.fullname = it.file.name;
            ul.appendChild(fli);
        });
        li.appendChild(ul);
        head.addEventListener('click', function(){
            const open = ul.style.display !== 'none';
            ul.style.display = open ? 'none' : '';
            caret.className = open ? 'bi bi-chevron-right vfs-caret' : 'bi bi-chevron-down vfs-caret';
        });
        return li;
    }
    async function buildVfsTree(){
        const c = document.getElementById('vfs-tree'); if (!c) return;
        c.innerHTML = '';
        const rootUl = document.createElement('ul'); rootUl.className='vfs-root';
        // Root node (expanded by default)
        const rootLi = document.createElement('li'); rootLi.className='vfs-node folder expanded';
        const head = document.createElement('div'); head.className='vfs-row';
        const caret = document.createElement('i'); caret.className='bi bi-chevron-down vfs-caret';
        const label = document.createElement('span'); label.className='vfs-label'; label.textContent='Root';
        head.appendChild(caret); head.appendChild(label); rootLi.appendChild(head);
        const rootChildren = document.createElement('ul'); rootChildren.className='vfs-children';
        // Root files and nested directories at top level (excluding projects/examples/shared/data)
        const rootFilesNest = nestFiles(vfs.listByFolder('Root'), '');
        // files directly under Root (no slash in name)
        rootFilesNest.files.forEach(it=>{
            const fli = document.createElement('li'); fli.className='vfs-node file';
            const row = document.createElement('div'); row.className='vfs-row';
            const icon = document.createElement('i'); icon.className='bi bi-file-earmark-text';
            const lab = document.createElement('span'); lab.className='vfs-label'; lab.textContent = it.label;
            row.appendChild(icon); row.appendChild(lab); fli.appendChild(row);
            fli.dataset.fullname = it.file.name;
            rootChildren.appendChild(fli);
        });
        // top-level nested folders under Root
        Object.keys(rootFilesNest.dirs).sort().forEach(dn=>{
            const li = renderTreeNode(dn, rootFilesNest.dirs[dn], dn + '/');
            rootChildren.appendChild(li);
        });
        // Projects folder
        const projContainer = document.createElement('li'); projContainer.className='vfs-node folder';
        const projHead = document.createElement('div'); projHead.className='vfs-row';
        const projCaret = document.createElement('i'); projCaret.className='bi bi-chevron-right vfs-caret';
        const projLabel = document.createElement('span'); projLabel.className='vfs-label'; projLabel.textContent='projects';
        projHead.appendChild(projCaret); projHead.appendChild(projLabel); projContainer.appendChild(projHead);
        const projChildren = document.createElement('ul'); projChildren.className='vfs-children'; projChildren.style.display='none';
        const projectNames = listLocalProjectNames();
        if (projectNames.length === 0){
            const placeholder = document.createElement('li'); placeholder.className='vfs-placeholder';
            placeholder.title = 'Create a new Project from the File Menu';
            placeholder.textContent = 'Create a new Project from the File Menu';
            projChildren.appendChild(placeholder);
        } else {
            // Build nested tree of all project files after 'projects/'
            const allProjFiles = vfs.listFiles().filter(f=>f.name.toLowerCase().startsWith('projects/'));
            const projNest = nestFiles(allProjFiles, 'projects/');
            Object.keys(projNest.dirs).sort().forEach(pn=>{
                const li = renderTreeNode(pn, projNest.dirs[pn], 'projects/' + pn + '/');
                projChildren.appendChild(li);
            });
        }
        projContainer.appendChild(projChildren);
        projHead.addEventListener('click', function(){
            const open = projChildren.style.display !== 'none';
            projChildren.style.display = open ? 'none' : '';
            projCaret.className = open ? 'bi bi-chevron-right vfs-caret' : 'bi bi-chevron-down vfs-caret';
        });
        rootChildren.appendChild(projContainer);
        // Demo folder
        const demoLi = document.createElement('li'); demoLi.className='vfs-node folder';
        const demoHead = document.createElement('div'); demoHead.className='vfs-row';
        const demoCaret = document.createElement('i'); demoCaret.className='bi bi-chevron-right vfs-caret';
        const demoLabel = document.createElement('span'); demoLabel.className='vfs-label'; demoLabel.textContent='demo';
        demoHead.appendChild(demoCaret); demoHead.appendChild(demoLabel); demoLi.appendChild(demoHead);
        const demoChildren = document.createElement('ul'); demoChildren.className='vfs-children'; demoChildren.style.display='none';
        try{
            const demoFiles = await vfs.listByFolderAsync('demo');
            const demoNest = nestFiles(demoFiles, 'demo/');
            Object.keys(demoNest.dirs).sort().forEach(dn=>{
                const li = renderTreeNode(dn, demoNest.dirs[dn], 'demo/' + dn + '/');
                demoChildren.appendChild(li);
            });
            demoNest.files.forEach(it=>{
                const fli = document.createElement('li'); fli.className='vfs-node file';
                const row = document.createElement('div'); row.className='vfs-row';
                const icon = document.createElement('i'); icon.className='bi bi-file-earmark-text';
                const lab = document.createElement('span'); lab.className='vfs-label'; lab.textContent = it.label;
                row.appendChild(icon); row.appendChild(lab); fli.appendChild(row);
                fli.dataset.fullname = it.file.name;
                demoChildren.appendChild(fli);
            });
        }catch(_){ /* ignore */ }
        demoLi.appendChild(demoChildren);
        demoHead.addEventListener('click', function(){
            const open = demoChildren.style.display !== 'none';
            demoChildren.style.display = open ? 'none' : '';
            demoCaret.className = open ? 'bi bi-chevron-right vfs-caret' : 'bi bi-chevron-down vfs-caret';
        });
        rootChildren.appendChild(demoLi);
        // Examples folder
        const exLi = document.createElement('li'); exLi.className='vfs-node folder';
        const exHead = document.createElement('div'); exHead.className='vfs-row';
        const exCaret = document.createElement('i'); exCaret.className='bi bi-chevron-right vfs-caret';
        const exLabel = document.createElement('span'); exLabel.className='vfs-label'; exLabel.textContent='examples';
        exHead.appendChild(exCaret); exHead.appendChild(exLabel); exLi.appendChild(exHead);
        const exChildren = document.createElement('ul'); exChildren.className='vfs-children'; exChildren.style.display='none';
        try{
            const exFiles = await vfs.listByFolderAsync('examples');
            const exNest = nestFiles(exFiles, 'examples/');
            Object.keys(exNest.dirs).sort().forEach(dn=>{
                const li = renderTreeNode(dn, exNest.dirs[dn], 'examples/' + dn + '/');
                exChildren.appendChild(li);
            });
            exNest.files.forEach(it=>{
                const fli = document.createElement('li'); fli.className='vfs-node file';
                const row = document.createElement('div'); row.className='vfs-row';
                const icon = document.createElement('i'); icon.className='bi bi-file-earmark-text';
                const lab = document.createElement('span'); lab.className='vfs-label'; lab.textContent = it.label;
                row.appendChild(icon); row.appendChild(lab); fli.appendChild(row);
                fli.dataset.fullname = it.file.name;
                exChildren.appendChild(fli);
            });
        }catch(_){ /* ignore */ }
        exLi.appendChild(exChildren);
        exHead.addEventListener('click', function(){
            const open = exChildren.style.display !== 'none';
            exChildren.style.display = open ? 'none' : '';
            exCaret.className = open ? 'bi bi-chevron-right vfs-caret' : 'bi bi-chevron-down vfs-caret';
        });
        rootChildren.appendChild(exLi);
        // Data folder
        const dataLi = document.createElement('li'); dataLi.className='vfs-node folder';
        const dataHead = document.createElement('div'); dataHead.className='vfs-row';
        const dataCaret = document.createElement('i'); dataCaret.className='bi bi-chevron-right vfs-caret';
        const dataLabel = document.createElement('span'); dataLabel.className='vfs-label'; dataLabel.textContent='data';
        dataHead.appendChild(dataCaret); dataHead.appendChild(dataLabel); dataLi.appendChild(dataHead);
        const dataChildren = document.createElement('ul'); dataChildren.className='vfs-children'; dataChildren.style.display='none';
        const dataNest = nestFiles(vfs.listByFolder('data'), 'data/');
        Object.keys(dataNest.dirs).sort().forEach(dn=>{
            const li = renderTreeNode(dn, dataNest.dirs[dn], 'data/' + dn + '/');
            dataChildren.appendChild(li);
        });
        dataNest.files.forEach(it=>{
            const fli = document.createElement('li'); fli.className='vfs-node file';
            const row = document.createElement('div'); row.className='vfs-row';
            const icon = document.createElement('i'); icon.className='bi bi-file-earmark-text';
            const lab = document.createElement('span'); lab.className='vfs-label'; lab.textContent = it.label;
            row.appendChild(icon); row.appendChild(lab); fli.appendChild(row);
            fli.dataset.fullname = it.file.name;
            dataChildren.appendChild(fli);
        });
        dataLi.appendChild(dataChildren);
        dataHead.addEventListener('click', function(){
            const open = dataChildren.style.display !== 'none';
            dataChildren.style.display = open ? 'none' : '';
            dataCaret.className = open ? 'bi bi-chevron-right vfs-caret' : 'bi bi-chevron-down vfs-caret';
        });
        rootChildren.appendChild(dataLi);
        // Shared folder
        const shLi = document.createElement('li'); shLi.className='vfs-node folder';
        const shHead = document.createElement('div'); shHead.className='vfs-row';
        const shCaret = document.createElement('i'); shCaret.className='bi bi-chevron-right vfs-caret';
        const shLabel = document.createElement('span'); shLabel.className='vfs-label'; shLabel.textContent='shared';
        shHead.appendChild(shCaret); shHead.appendChild(shLabel); shLi.appendChild(shHead);
        const shChildren = document.createElement('ul'); shChildren.className='vfs-children'; shChildren.style.display='none';
        try{
            const shFiles = await vfs.listByFolderAsync('shared');
            const shNest = nestFiles(shFiles, 'shared/');
            Object.keys(shNest.dirs).sort().forEach(dn=>{
                const li = renderTreeNode(dn, shNest.dirs[dn], 'shared/' + dn + '/');
                shChildren.appendChild(li);
            });
            shNest.files.forEach(it=>{
                const fli = document.createElement('li'); fli.className='vfs-node file';
                const row = document.createElement('div'); row.className='vfs-row';
                const icon = document.createElement('i'); icon.className='bi bi-file-earmark-text';
                const lab = document.createElement('span'); lab.className='vfs-label'; lab.textContent = it.label;
                row.appendChild(icon); row.appendChild(lab); fli.appendChild(row);
                fli.dataset.fullname = it.file.name;
                shChildren.appendChild(fli);
            });
        }catch(_){ /* ignore */ }
        shLi.appendChild(shChildren);
        shHead.addEventListener('click', function(){
            const open = shChildren.style.display !== 'none';
            shChildren.style.display = open ? 'none' : '';
            shCaret.className = open ? 'bi bi-chevron-right vfs-caret' : 'bi bi-chevron-down vfs-caret';
        });
        rootChildren.appendChild(shLi);

        rootLi.appendChild(rootChildren); rootUl.appendChild(rootLi); c.appendChild(rootUl);
        // Click to open files (bind once)
        if (!c.dataset.boundClick){
            c.addEventListener('click', async function(ev){
                const target = ev.target;
                const li = target && (target.closest('li.vfs-node.file'));
                if (!li) return;
                const fullName = li.dataset.fullname;
                if (!fullName) return;
                // Reuse open logic from Open dialog
                if (tabs.length >= MAX_TABS){ alert(`You have reached the tab limit (${MAX_TABS}). Close a tab to open another.`); return; }
                const isRemote = /^examples\//i.test(fullName) || /^shared\//i.test(fullName) || /^demo\//i.test(fullName);
                const file = isRemote ? (await vfs.getFileAsync(fullName)) : vfs.getFile(fullName);
                if (!file) return;
                // avoid duplicate open: if already open by full path, activate
                const existing = findTabByFullName(file.name);
                if (existing){ activateTab(existing.id); openEditor(true); return; }
                const displayName = fullName.includes('/') ? fullName.split('/').pop() : fullName;
                createNewTab({ content: file.content || '', fullName: file.name, readOnly: !!file.readOnly, displayName });
                openEditor(true);
            });
            c.dataset.boundClick = '1';
        }
    }

    // Wire drawers after DOM ready (append listener at end of existing ready callback)
    $(function(){
        // Toggle buttons
        document.getElementById('toggle-left-drawer')?.addEventListener('click', function(){ toggleLeftDrawer(); });
        document.getElementById('toggle-right-drawer')?.addEventListener('click', function(){ toggleRightDrawer(); });
        document.getElementById('left-drawer-close')?.addEventListener('click', function(){ toggleLeftDrawer(false); });
        document.getElementById('right-drawer-close')?.addEventListener('click', function(){ toggleRightDrawer(false); });
        document.getElementById('left-drawer-refresh')?.addEventListener('click', function(){ try{ buildVfsTree(); }catch(_){ console.warn('Refresh failed'); } });
        // Initialize displacement offsets based on current open state
        try{ updateDrawerOffsets(); }catch(_){ }
        // Open both drawers by default unless a sharedProject is specified in URL
        try{
            const params = new URLSearchParams(location.search);
            const hasSharedProject = !!params.get('sharedProject');
            if (!hasSharedProject){
                toggleLeftDrawer(true);
                toggleRightDrawer(true);
            } else {
                // ensure both closed if param present
                toggleLeftDrawer(false);
                toggleRightDrawer(false);
            }
        }catch(_){}
        // Build initial tree
        try{ buildVfsTree(); }catch(e){ console.warn('VFS tree build failed', e); }
        // Extra global keyboard: F1 toggles right; F8 executes selection (if any) when editor focused; F9 runs whole program when editor focused; ESC closes drawers unless modal open
        document.addEventListener('keydown', function(e){
            // Ctrl/Cmd+S ‚Üí Save (or Save As when untitled/read-only)
            if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')){
                e.preventDefault();
                try{ onFileSave(); }catch(_){ }
                return;
            }
            // Ctrl/Cmd+N ‚Üí New file (same as clicking the + tab)
            if ((e.ctrlKey || e.metaKey) && (e.key === 'n' || e.key === 'N')){
                e.preventDefault();
                try{ onFileNew(); }catch(_){ }
                return;
            }
            // Intercept F5 to prevent accidental page refresh
            if (e.key === 'F5') { e.preventDefault(); return; }
            const k = e.key;
            if (k === 'F1'){
                e.preventDefault(); // Always prevent default help
                toggleRightDrawer();
                return;
            }
            if (k === 'F6'){
                // Toggle focus between editor and terminal when one of them is focused
                const ae = document.activeElement;
                const t = getActiveTab();
                const inEditor = (t && t.cm && t.cm.hasFocus && t.cm.hasFocus()) || (ae && ae.classList && ae.classList.contains('editor-textarea'));
                const termHost = document.getElementById('terminal');
                const inTerminal = termHost ? termHost.contains(ae) : false;
                if (inEditor){ e.preventDefault(); if (term && term.focus) term.focus(true); return; }
                if (inTerminal){ e.preventDefault(); focusActiveEditor(); return; }
            }
            if (k === 'F8'){
                const t = getActiveTab();
                const cmHasFocus = !!(t && t.cm && t.cm.hasFocus && t.cm.hasFocus());
                const ed = getActiveEditor();
                const ae = document.activeElement;
                if (cmHasFocus || (ed && (ae === ed))){
                    const sel = getEditorSelectionText(ed);
                    if (sel && sel.trim().length > 0){
                        e.preventDefault();
                        execSelection();
                    }
                }
                return; // let browser handle otherwise
            }
            if (k === 'F9'){
                const t = getActiveTab();
                const cmHasFocus = !!(t && t.cm && t.cm.hasFocus && t.cm.hasFocus());
                const ae = document.activeElement;
                if (cmHasFocus || (ae && (ae.classList && ae.classList.contains('editor-textarea')))){
                    e.preventDefault();
                    runProgram();
                }
                return; // let browser handle otherwise
            }
            if (k === 'Escape'){
                if (!isAnyModalOpen()){
                    closeDrawers();
                }
            }
        }, true);
    });

})();
</script>

<!-- Slide-out Drawers Markup and Styles -->
<style id="drawers-style">
:root{
  --left-drawer-width: 400px; /* adjust left drawer width here */
  --right-drawer-width: 500px; /* adjust right drawer width here */
  /* Offsets applied to content area to displace (not occlude) when drawers are open */
  --left-offset: 0px;
  --right-offset: 0px;
}
.drawer{ position: fixed; top: var(--nav-height); bottom: 0; background: #0f1f46; color: #e6f0ff; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 1040; transition: transform .2s ease-in-out; display: flex; flex-direction: column; }
.drawer .drawer-header{ display:flex; align-items:center; justify-content: space-between; padding: .5rem .75rem; background: #0a1633; border-bottom: 1px solid #1e2a55; }
.drawer .drawer-body{ overflow: auto; padding: .5rem .5rem; flex: 1 1 auto; }
#right-drawer .drawer-header{ padding-right: 48px; }
.drawer-left{ left: 0; width: var(--left-drawer-width); transform: translateX(calc(-1 * var(--left-drawer-width))); border-right: 1px solid #1e2a55; }
.drawer-left.open{ transform: translateX(0); }
.drawer-right{ right: 0; width: var(--right-drawer-width); transform: translateX(var(--right-drawer-width)); border-left: 1px solid #1e2a55; }
.drawer-right.open{ transform: translateX(0); }
.drawer-toggle{ position: fixed; top: calc(var(--nav-height) + 8px); padding: .25rem .5rem; z-index: 1041; border: 1px solid #1e2a55; background:#0a1633; color:#e6f0ff; border-radius: .25rem; }
.drawer-toggle.left{ left: 8px; }
.drawer-toggle.right{ right: 8px; }
/* Displace center content instead of overlaying it */
#work-area{ margin-left: var(--left-offset); margin-right: var(--right-offset); transition: margin .2s ease-in-out; }
/* VFS Tree styles */
.vfs-root, .vfs-children{ list-style: none; margin: 0; padding-left: .5rem; }
.vfs-node .vfs-row{ display:flex; align-items:center; gap:.35rem; padding:.1rem .25rem; user-select:none; cursor: default; }
.vfs-node.folder .vfs-row{ cursor: pointer; }
.vfs-node.file .vfs-row{ cursor: pointer; }
.vfs-node.file .vfs-row:hover{ background: rgba(255,255,255,0.08); }
.vfs-caret{ width: 1rem; text-align: center; }
.vfs-placeholder{ color: #9aa9c7; font-style: italic; padding: .1rem .25rem; }
/* Right drawer iframe */
#right-iframe{ width: 100%; height: 100%; border: 0; background: #fff; color: #000; }
/* Offset the editor tabs so the left hamburger never covers the first tab (adjustable) */
#editor-tabs{ padding-left: 48px; /* adjust spacing to match hamburger size */ }
/* Keep navbar above drawers but below modal backdrop */
.navbar{ z-index: 1045; }
/* Ensure dropdown menus appear above slide-out drawers (stays within navbar stacking context) */
.navbar .dropdown-menu{ z-index: 1052; }
/* Shift Explorer title right so hamburger toggle never overlaps */
#left-drawer .drawer-header .fw-bold{ margin-left: 48px; }
</style>

<button id="toggle-left-drawer" class="drawer-toggle left" type="button" aria-expanded="false" title="Toggle Files">‚ò∞</button>
<button id="toggle-right-drawer" class="drawer-toggle right" type="button" aria-expanded="false" title="Toggle Home (F1)">‚åò</button>

<div id="left-drawer" class="drawer drawer-left" aria-label="Explorer">
  <div class="drawer-header">
    <div class="fw-bold">Explorer</div>
    <div class="d-flex gap-2">
      <button id="left-drawer-refresh" class="btn btn-sm btn-outline-light">Refresh</button>
      <button id="left-drawer-close" class="btn btn-sm btn-outline-light">Close</button>
    </div>
  </div>
  <div class="drawer-body">
    <div class="accordion" id="leftAccordion">
      <div class="accordion-item bg-transparent text-light border-secondary">
        <h2 class="accordion-header" id="acc-files-h">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#acc-files" aria-expanded="true" aria-controls="acc-files">Files</button>
        </h2>
        <div id="acc-files" class="accordion-collapse collapse show" aria-labelledby="acc-files-h" data-bs-parent="#leftAccordion">
          <div class="accordion-body p-2">
            <div id="vfs-tree"></div>
          </div>
        </div>
      </div>
      <div class="accordion-item bg-transparent text-light border-secondary">
        <h2 class="accordion-header" id="acc-watch-h">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc-watch" aria-expanded="false" aria-controls="acc-watch">Watch</button>
        </h2>
        <div id="acc-watch" class="accordion-collapse collapse" aria-labelledby="acc-watch-h" data-bs-parent="#leftAccordion">
          <div class="accordion-body p-2">
            <div class="text-secondary">Todo: variable watch and stack info will appear here.</div>
          </div>
        </div>
      </div>
      <div class="accordion-item bg-transparent text-light border-secondary">
        <h2 class="accordion-header" id="acc-msg-h">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc-msg" aria-expanded="false" aria-controls="acc-msg">Message</button>
        </h2>
        <div id="acc-msg" class="accordion-collapse collapse" aria-labelledby="acc-msg-h" data-bs-parent="#leftAccordion">
          <div class="accordion-body p-2">
            <div class="text-secondary">Todo: console/debug messages will appear here.</div>
          </div>
        </div>
      </div>
      <div class="accordion-item bg-transparent text-light border-secondary">
        <h2 class="accordion-header" id="acc-chat-h">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc-chat" aria-expanded="false" aria-controls="acc-chat">Chat</button>
        </h2>
        <div id="acc-chat" class="accordion-collapse collapse" aria-labelledby="acc-chat-h" data-bs-parent="#leftAccordion">
          <div class="accordion-body p-2 d-flex flex-column" style="height: 350px;">
            <div id="chat-messages" class="flex-grow-1 overflow-auto mb-2" style="font-size: 0.9rem; scroll-behavior: smooth;"></div>
            <div class="input-group input-group-sm">
              <input type="text" id="chat-input" class="form-control bg-dark text-light border-secondary" placeholder="Type a message...">
              <button class="btn btn-outline-secondary" id="chat-send">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Side terminal host (hidden until used) -->
    <div id="left-terminal-host" class="mt-2">
      <div class="small text-secondary mb-1">Terminal</div>
      <div id="terminal-side-host"></div>
    </div>
  </div>
</div>

<!-- Floating terminal dialog (always-on-top) -->
<div id="terminal-dialog" role="dialog" aria-label="Terminal dialog">
  <div class="td-header">Terminal ‚Äî double‚Äëclick to dock</div>
  <div class="td-body">
    <div id="terminal-dialog-host" class="h-100 w-100"></div>
  </div>
</div>

<div id="right-drawer" class="drawer drawer-right" aria-label="Home">
  <div class="drawer-header">
<!--      <div class="fw-bold">Home</div>-->

      <a href="html/index.html" target="right-iframe" class="btn btn-sm btn-outline-light">Home</a>
      <button id="right-drawer-close" class="btn btn-sm btn-outline-light">Close</button>
  </div>
  <div class="drawer-body p-0">
    <iframe id="right-iframe" name="right-iframe" src="html/index.html" title="Tutorial"></iframe>
  </div>
</div>
<script>
    // Junie, look at this:
    const YoBasicIDE = window.YoBasicIDE = window.YoBasicIDE || {};

    // Example helper: open example files as tabs in your editor (real wiring)
    YoBasicIDE.openExample = function (payload) {
        try{
            const bridge = window.__YoBasicBridge__;
            if (!bridge || typeof bridge.openTab !== 'function'){
                console.warn('YoBasic bridge not available');
                return;
            }
            // Decide main file
            const files = Array.isArray(payload.files) ? payload.files : [];
            if (!files.length) return;
            const main = files.find(f=>String(f.role||'').toLowerCase()==='main') || files[0];
            // Open aux files first
            files.forEach(f=>{
                if (f === main) return;
                bridge.openTab({
                    content: f.content || '',
                    fullName: f.name || null,
                    readOnly: false,
                    displayName: (f.name && f.name.includes('/') ? f.name.split('/').pop() : (f.name || 'Untitled'))
                });
            });
            // Open main last to focus
            const mainTabId = bridge.openTab({
                content: main.content || '',
                fullName: main.name || null,
                readOnly: false,
                displayName: (main.name && main.name.includes('/') ? main.name.split('/').pop() : (main.name || 'Untitled'))
            });
            if (mainTabId != null && typeof bridge.activateTab === 'function'){
                bridge.activateTab(mainTabId);
            }
            // Ensure editor is visible
            if (typeof bridge.openEditor === 'function') bridge.openEditor(true);
        }catch(e){ console.warn('openExample failed', e); }
    };

    // Listen for messages from the iframe
    window.addEventListener("message", function (event) {
        // SECURITY: Ideally, restrict to same-origin:
        if (event.origin !== window.location.origin) {
            return;
        }

        const data = event.data;
        if (!data || typeof data !== "object") return;

        if (data.type === "YoBasicOpenExample") {
            YoBasicIDE.openExample(data);
        }
    });
</script>

</body>
</html>