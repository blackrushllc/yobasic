<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>YoBASIC</title>
    <!-- Bootstrap CSS & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!-- jQuery & jQuery Terminal -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.terminal/css/jquery.terminal.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal/js/jquery.terminal.min.js"></script>

    <script src="https://unpkg.com/js-polyfills/keyboard.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jcubic/static/js/wcwidth.js"></script>

    <script src="vfs.js"></script>
    <script src="supabaseClient.js"></script>
    <script src="identity.js"></script>
    <script src="provider-examples.js"></script>
    <script src="provider-shared.js"></script>
    <script src="basic.js"></script>
    <script src="projectManager.js"></script>
    <style>
        :root { --nav-height: 56px; }
        html, body { height: 100%; }
        body {
            background: #0b1b3b; /* subtle QBasic navy vibe */
            color: #e6f0ff;
            font-family: "Courier New", Consolas, "Lucida Console", monospace;
        }
        .navbar-brand, .nav-link, .dropdown-item { user-select: none; }
        .qb-underline { text-decoration: underline; }
        /* layout */
        #work-area { height: calc(100vh - var(--nav-height)); margin-top: var(--nav-height); }
        #editor-pane { background: #031634; }
        .editor-textarea, #editor { width: 100%; height: 100%; resize: none; background: transparent; color: #e6f0ff; border: none; outline: none; }
        .editor-view { display: none; height: 100%; }
        .editor-view.active { display: block; }
        #editor-tabs .nav-link { display: flex; align-items: center; gap: .25rem; }
        #editor-tabs .tab-close { font-weight: bold; opacity: .7; cursor: pointer; }
        #editor-tabs .tab-close:hover { opacity: 1; }
        #terminal-pane, #terminal { height: 100%; }
        /* jQuery Terminal theme tweaks */
        #terminal .terminal { --size: 1rem; }
        .terminal, .terminal .terminal-output { background: #001a33; color: #e6f0ff; }
        .terminal .prompt { color: #9ad1ff; }
        .terminal .cursor { background: #9ad1ff; }
        /* Buttons */
        .toolbar .btn { margin-left: .25rem; }
    </style>
</head>
<body>
<nav id="topnav" class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">ðŸŒ±YoBASIC</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item dropdown">
                    <a id="menu-file" class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">File</a>
                    <ul class="dropdown-menu" aria-labelledby="menu-file">
                        <li><a class="dropdown-item" href="#" data-action="file-new" data-key="n"><span class="qb-underline">N</span>ew</a></li>
                        <li><a class="dropdown-item" href="#" data-action="file-open" data-key="o"><span class="qb-underline">O</span>pen</a></li>
                        <li><a class="dropdown-item" href="#" data-action="file-save" data-key="s"><span class="qb-underline">S</span>ave</a></li>
                        <li><a class="dropdown-item" href="#" data-action="file-saveas" data-key="a">Save <span class="qb-underline">A</span>s</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-action="file-close" data-key="c"><span class="qb-underline">C</span>lose</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-action="proj-new" data-key="p">New <span class="qb-underline">P</span>roject</a></li>
                        <li><a class="dropdown-item" href="#" data-action="proj-open" data-key="j">Open Pro<span class="qb-underline">j</span>ect</a></li>
                        <li><a class="dropdown-item" href="#" data-action="proj-close" data-key="l">C<span class="qb-underline">l</span>ose Project</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a id="menu-tools" class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Tools</a>
                    <ul class="dropdown-menu" aria-labelledby="menu-tools">
                        <li><a class="dropdown-item" href="#" data-action="tool-1" data-key="1">Tool 1</a></li>
                        <li><a class="dropdown-item" href="#" data-action="tool-2" data-key="2">Tool 2</a></li>
                        <li><a class="dropdown-item" href="#" data-action="tool-3" data-key="3">Tool 3</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a id="menu-help" class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Help</a>
                    <ul class="dropdown-menu" aria-labelledby="menu-help">
                        <li><a class="dropdown-item" href="#" data-action="help-1" data-key="1">Help 1</a></li>
                        <li><a class="dropdown-item" href="#" data-action="help-2" data-key="2">Help 2</a></li>
                        <li><a class="dropdown-item" href="#" data-action="help-3" data-key="3">Help 3</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-action="about" data-key="a">About</a></li>
                    </ul>
                </li>
            </ul>
            <div class="toolbar d-flex ms-auto">
                <button id="btn-run" class="btn btn-outline-light btn-sm" title="Run (execute program)"><i class="bi bi-play-fill me-1"></i>Run</button>
                <button id="btn-clear" class="btn btn-outline-success btn-sm" title="Clear Output"><i class="bi bi-ban-fill me-1"></i>Clear</button>
                <button id="btn-bug" class="btn btn-outline-warning btn-sm" title="Toggle Tron/Troff (Debug Mode)"><i class="bi bi-bug-fill me-1"></i>Tron/Troff</button>
                <button id="btn-build" class="btn btn-outline-info btn-sm" title="Build"><i class="bi bi-hammer me-1"></i>Build</button>
                <button id="btn-settings" class="btn btn-outline-light btn-sm" title="Settings"><i class="bi bi-gear-fill me-1"></i>Settings</button>
                <button id="btn-identity" class="btn btn-outline-primary btn-sm ms-2" title="Identity"><i class="bi bi-person-badge me-1"></i><span id="identity-label">Login</span></button>
            </div>
        </div>
    </div>
</nav>

<div id="work-area" class="container-fluid p-0">
    <div id="editor-pane" class="d-none p-2 border-bottom" style="height: 60%; display: flex; flex-direction: column;">
        <ul id="editor-tabs" class="nav nav-tabs small mb-2"></ul>
        <div id="editor-views" class="flex-grow-1">
            <div class="editor-view active" data-tab-id="0" style="height: 100%;">
                <textarea id="editor" class="editor-textarea" spellcheck="false"></textarea>
            </div>
        </div>
    </div>
    <div id="terminal-pane" class="p-0" style="height: calc(100vh - var(--nav-height));">
        <div id="terminal" class="h-100"></div>
    </div>
</div>

<!-- About Modal -->
<div class="modal fade" id="modalAbout" tabindex="-1" aria-labelledby="aboutLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="aboutLabel">About</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>YoBASIC is a subset of the BasilðŸŒ¿ programming language and presented here as an interactive learning tool for beginners and a sandbox for experienced developers.</p>
        <p>Both the Editor and the file I/O functions in BASIC make use of a simulated file system that uses local storage in your browser and will persist between sessions. </p>
        <p><a class="link-info" href="https://basilbasic.com" target="_blank" rel="noopener">Visit basilbasic.com</a></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Identity Modal -->
<div class="modal fade" id="modalIdentity" tabindex="-1" aria-labelledby="identityLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="identityLabel">Identity</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="identity-status" class="mb-3 small text-secondary">You are not logged in.</div>
        <div id="identity-forms">
          <ul class="nav nav-tabs" id="identityTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-login-tab" data-bs-toggle="tab" data-bs-target="#tab-login" type="button" role="tab" aria-controls="tab-login" aria-selected="true">Log In</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-signup-tab" data-bs-toggle="tab" data-bs-target="#tab-signup" type="button" role="tab" aria-controls="tab-signup" aria-selected="false">Create Identity</button>
            </li>
          </ul>
          <div class="tab-content p-3">
            <div class="tab-pane fade show active" id="tab-login" role="tabpanel" aria-labelledby="tab-login-tab">
              <div class="mb-2">
                <label class="form-label">Username or Email</label>
                <input id="login-username" type="text" class="form-control form-control-sm" placeholder="yourname or you@example.com" />
              </div>
              <div class="mb-2">
                <label class="form-label">Password</label>
                <input id="login-password" type="password" class="form-control form-control-sm" />
              </div>
              <button id="btn-login" type="button" class="btn btn-primary">Log In</button>
            </div>
            <div class="tab-pane fade" id="tab-signup" role="tabpanel" aria-labelledby="tab-signup-tab">
              <div class="mb-2">
                <label class="form-label">Username</label>
                <input id="signup-username" type="text" class="form-control form-control-sm" placeholder="yourname" />
              </div>
              <div class="mb-2">
                <label class="form-label">Email</label>
                <input id="signup-email" type="email" class="form-control form-control-sm" placeholder="you@example.com" />
              </div>
              <div class="mb-2">
                <label class="form-label">Password</label>
                <input id="signup-password" type="password" class="form-control form-control-sm" />
              </div>
              <div class="form-text text-secondary mb-2">After signing up, check your email and confirm your address, then return here to log in.</div>
              <button id="btn-signup" type="button" class="btn btn-success">Create Identity</button>
            </div>
          </div>
        </div>
        <div id="identity-loggedin" class="d-none">
          <p>You are <span id="whoami"></span>.</p>
          <button id="btn-logout" type="button" class="btn btn-warning">Log Out</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="modalSettings" tabindex="-1" aria-labelledby="settingsLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="settingsLabel">Settings</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-appearance-tab" data-bs-toggle="tab" data-bs-target="#tab-appearance" type="button" role="tab" aria-controls="tab-appearance" aria-selected="true">Appearance</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-2-tab" data-bs-toggle="tab" data-bs-target="#tab-2" type="button" role="tab" aria-controls="tab-2" aria-selected="false">Tab 2</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-3-tab" data-bs-toggle="tab" data-bs-target="#tab-3" type="button" role="tab" aria-controls="tab-3" aria-selected="false">Tab 3</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-4-tab" data-bs-toggle="tab" data-bs-target="#tab-4" type="button" role="tab" aria-controls="tab-4" aria-selected="false">Tab 4</button>
          </li>
        </ul>
        <div class="tab-content p-3">
          <div class="tab-pane fade show active" id="tab-appearance" role="tabpanel" aria-labelledby="tab-appearance-tab">
            <div class="row g-3">
              <div class="col-md-6">
                <h6>Editor</h6>
                <div class="mb-2">
                  <label class="form-label">Font Face</label>
                  <select id="editor-font" class="form-select form-select-sm">
                    <option>Courier New</option>
                    <option>Consolas</option>
                    <option>Fira Code</option>
                    <option>Monaco</option>
                    <option>Lucida Console</option>
                    <option>IBM Plex Mono</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Font Size (px)</label>
                  <input id="editor-size" type="number" min="10" max="48" step="1" class="form-control form-control-sm" />
                </div>
                <div class="mb-2">
                  <label class="form-label">Font Color</label>
                  <input id="editor-color" type="color" class="form-control form-control-color form-control-sm" />
                </div>
                <div class="mb-2">
                  <label class="form-label">Background</label>
                  <input id="editor-bg" type="color" class="form-control form-control-color form-control-sm" />
                </div>
              </div>
              <div class="col-md-6">
                <h6>Terminal</h6>
                <div class="mb-2">
                  <label class="form-label">Font Face</label>
                  <select id="terminal-font" class="form-select form-select-sm">
                    <option>Courier New</option>
                    <option>Consolas</option>
                    <option>Fira Code</option>
                    <option>Monaco</option>
                    <option>Lucida Console</option>
                    <option>IBM Plex Mono</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Font Size (px)</label>
                  <input id="terminal-size" type="number" min="10" max="48" step="1" class="form-control form-control-sm" />
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="tab-2" role="tabpanel" aria-labelledby="tab-2-tab">
            <p class="text-muted">No content yet.</p>
          </div>
          <div class="tab-pane fade" id="tab-3" role="tabpanel" aria-labelledby="tab-3-tab">
            <p class="text-muted">No content yet.</p>
          </div>
          <div class="tab-pane fade" id="tab-4" role="tabpanel" aria-labelledby="tab-4-tab">
            <p class="text-muted">No content yet.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-save-settings" type="button" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Open Dialog -->
<div class="modal fade" id="modalOpen" tabindex="-1" aria-labelledby="openLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="openLabel">OPEN</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-4 border-end">
            <div class="list-group" id="open-folders">
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark active" data-folder="Root">Root</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="projects">projects</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="examples">examples</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="data">data</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="shared">shared</button>
              <div id="open-projects" class="mt-2"></div>
              <div id="open-shared-owners" class="mt-2"></div>
            </div>
          </div>
          <div class="col-8">
            <div class="small text-secondary mb-2">Double-click to open.</div>
            <div class="list-group" id="open-files" style="max-height: 50vh; overflow:auto"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-open-ok" type="button" class="btn btn-primary" disabled>Open</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Save As Dialog -->
<div class="modal fade" id="modalSaveAs" tabindex="-1" aria-labelledby="saveasLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="saveasLabel">SAVE FILE</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-4 border-end">
            <div class="list-group" id="save-folders">
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark active" data-folder="Root">Root</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="projects">projects</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="examples" disabled>examples</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="data" disabled>data</button>
              <button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-folder="shared">shared</button>
            </div>
          </div>
          <div class="col-8">
            <div class="mb-2">
              <label class="form-label">File name</label>
              <input id="saveas-name" type="text" class="form-control form-control-sm" placeholder="MYPROGRAM.BAS" />
              <div class="form-text text-secondary">Programs are saved in Root as .BAS files.</div>
            </div>
            <div id="save-files" class="list-group" style="max-height: 50vh; overflow:auto"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-saveas-ok" type="button" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Bundle (with Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
    var __EVAL = (s) => eval(`void (__EVAL = ${__EVAL}); ${s}`);
    let term, basic;
    let debugOn = true;
    let currentMenu = null; // bootstrap.Dropdown instance

    // --- Tabbed editor state ---
    const MAX_TABS = 20; // change to adjust tab limit
    let tabs = [];
    let activeTabId = 0;
    let nextTabId = 1; // 0 is the fixed first tab
    
    function getActiveTab(){ return tabs.find(t => t.id === activeTabId); }
    function getTabById(id){ return tabs.find(t => t.id === id); }
    function getActiveEditor(){ const t = getActiveTab(); return t ? t.textarea : document.getElementById('editor'); }
    function setTabTitle(tabId, displayName, fullName){
        const tab = getTabById(tabId); if (!tab) return;
        tab.displayName = displayName || 'Untitled';
        tab.fullName = fullName || null;
        const btn = document.querySelector(`#editor-tabs [data-tab-id="${tabId}"]`);
        if (btn){ btn.querySelector('.tab-title').textContent = tab.displayName; btn.title = tab.fullName || tab.displayName; }
    }
    function activateTab(tabId){
        const tab = getTabById(tabId); if (!tab) return;
        // toggle tab buttons
        document.querySelectorAll('#editor-tabs .nav-link').forEach(el=>el.classList.remove('active'));
        const btn = document.querySelector(`#editor-tabs [data-tab-id="${tabId}"]`);
        if (btn) btn.classList.add('active');
        // toggle views
        document.querySelectorAll('#editor-views .editor-view').forEach(v=>v.classList.remove('active'));
        const view = document.querySelector(`#editor-views .editor-view[data-tab-id="${tabId}"]`);
        if (view) view.classList.add('active');
        activeTabId = tabId;
        // sync globals used by existing dialogs
        currentFileName = tab.fullName || null;
        currentFileReadOnly = !!tab.readOnly;
        // focus editor
        setTimeout(()=>{ try{ tab.textarea.focus(); }catch(e){} }, 0);
    }
    function buildInitialTabUi(){
        // Create first tab button if not present
        const list = document.getElementById('editor-tabs');
        if (!list) return;
        if (list.children.length === 0){
            const li = document.createElement('li'); li.className = 'nav-item';
            const btn = document.createElement('button'); btn.className = 'nav-link active'; btn.type='button'; btn.setAttribute('data-tab-id','0'); btn.title='Untitled';
            btn.innerHTML = '<span class="tab-title">Untitled</span> <span class="tab-close" aria-label="Close" title="Close">Ã—</span>';
            li.appendChild(btn); list.appendChild(li);
            btn.addEventListener('click', function(e){ if (e.target.classList.contains('tab-close')) return; activateTab(0); });
            btn.querySelector('.tab-close').addEventListener('click', function(e){ e.stopPropagation(); onFileCloseTab(); });
        }
        // Register first tab object using existing #editor
        if (!tabs.find(t=>t.id===0)){
            const textarea = document.getElementById('editor');
            const view = document.querySelector('#editor-views .editor-view[data-tab-id="0"]');
            tabs.push({ id: 0, textarea, view, fullName: null, readOnly: false, displayName: 'Untitled' });
            // bind input autosave on first tab too
            textarea.addEventListener('input', function(){ saveCode(); });
        }
    }
    function createNewTab(initial){
        if (tabs.length >= MAX_TABS){ alert(`You have reached the tab limit (${MAX_TABS}). Close a tab to open another.`); return null; }
        const id = nextTabId++;
        // view
        const view = document.createElement('div'); view.className='editor-view'; view.style.height='100%'; view.setAttribute('data-tab-id', String(id));
        const ta = document.createElement('textarea'); ta.className='editor-textarea'; ta.spellcheck=false; view.appendChild(ta);
        document.getElementById('editor-views').appendChild(view);
        // button
        const li = document.createElement('li'); li.className = 'nav-item';
        const btn = document.createElement('button'); btn.className='nav-link'; btn.type='button'; btn.setAttribute('data-tab-id', String(id));
        btn.innerHTML = '<span class="tab-title">Untitled</span> <span class="tab-close" aria-label="Close" title="Close">Ã—</span>';
        li.appendChild(btn); document.getElementById('editor-tabs').appendChild(li);
        btn.addEventListener('click', function(e){ if (e.target.classList.contains('tab-close')) return; activateTab(id); });
        btn.querySelector('.tab-close').addEventListener('click', function(e){ e.stopPropagation(); closeTab(id); });
        // settings apply to new textarea
        const s = loadSettings();
        if (s && s.editor){
            if (s.editor.fontFamily) ta.style.fontFamily = s.editor.fontFamily + ', monospace';
            if (s.editor.fontSize) ta.style.fontSize = s.editor.fontSize + 'px';
            if (s.editor.color) ta.style.color = s.editor.color;
            if (s.editor.bg) ta.style.backgroundColor = s.editor.bg;
        }
        ta.addEventListener('input', function(){ saveCode(); });
        const tab = { id, textarea: ta, view, fullName: null, readOnly: false, displayName: 'Untitled' };
        tabs.push(tab);
        // initial content/meta
        if (initial){
            if (typeof initial.content === 'string'){ ta.value = initial.content; }
            if (initial.fullName){ tab.fullName = initial.fullName; }
            if (initial.readOnly){ tab.readOnly = !!initial.readOnly; }
            const title = initial.displayName || (initial.fullName ? (initial.fullName.includes('/')? initial.fullName.split('/').pop() : initial.fullName) : 'Untitled');
            setTabTitle(id, title, initial.fullName || title);
        } else {
            setTabTitle(id, 'Untitled', 'Untitled');
        }
        // show editor and activate
        openEditor(true);
        activateTab(id);
        return tab;
    }
    function closeTab(id){
        const idx = tabs.findIndex(t=>t.id===id);
        if (idx < 0) return;
        if (id === 0 || tabs.length === 1){
            // clear first/only tab per spec
            const t0 = getTabById(id);
            if (t0){ t0.textarea.value = ''; t0.fullName = null; t0.readOnly = false; setTabTitle(id, 'Untitled', 'Untitled'); saveCode(''); }
            activateTab(id);
            return;
        }
        // compute previous tab id (immediate prior visually is previous in array if exists, else previous sibling in DOM)
        const prev = tabs[idx-1] || tabs[0];
        // remove DOM
        const btn = document.querySelector(`#editor-tabs [data-tab-id="${id}"]`);
        if (btn){ const li = btn.parentElement; li && li.remove(); }
        const view = document.querySelector(`#editor-views .editor-view[data-tab-id="${id}"]`);
        if (view){ view.remove(); }
        // remove from state
        tabs.splice(idx,1);
        // activate previous
        activateTab(prev.id);
    }
    
    async function tryLoadSharedProjectFromUrl(){
        const params = new URLSearchParams(location.search);
        const sp = params.get('sharedProject');
        if (!sp) return;
        const m = String(sp).match(/^([^\/]+)\/(.+)$/);
        if (!m) return;
        const owner = decodeURIComponent(m[1]);
        const proj = decodeURIComponent(m[2]);
        // Fetch file list for owner and hydrate only this project's files
        const prov = vfs && vfs.providers && vfs.providers.shared;
        if (!prov || !prov.listFilesForOwner || !prov.getFile) return;
        const files = await prov.listFilesForOwner(owner);
        const prefix = `shared/${owner}/projects/${proj}/`.toLowerCase();
        const matches = files.filter(f=>String(f.name).toLowerCase().startsWith(prefix));
        if (!matches.length){ console.warn('No shared files for project', proj); return; }
        for (const f of matches){
            // Fetch full content
            const full = await prov.getFile(f.name);
            if (!full) continue;
            // Compute local path under projects/<proj>/...
            const rest = full.name.slice(prefix.length);
            const localPath = `projects/${proj}/${rest}`;
            // Write to local VFS preserving kind
            vfs.writeFile(localPath, full.content || '', full.kind || 'program');
        }
        // Open project after hydration
        if (window.ProjectManager && ProjectManager.init){ ProjectManager.init(vfs); }
        if (window.ProjectManager && ProjectManager.openProject){ await ProjectManager.openProject(proj); }
    }

    // VFS and editor current file state
    let vfs = null;
    let currentFileName = null;
    let currentFileReadOnly = false;

    function setNavHeight() {
        const h = document.getElementById('topnav').offsetHeight || 56;
        document.body.style.setProperty('--nav-height', h + 'px');
        // adjust terminal pane height depending on editor visibility
        const editorVisible = !document.getElementById('editor-pane').classList.contains('d-none');
        const tp = document.getElementById('terminal-pane');
        if (editorVisible) {
            // editor 60%, terminal 40% of remaining work area
            document.getElementById('editor-pane').style.height = '60%';
            tp.style.height = '40%';
        } else {
            // terminal fills the work area when editor hidden
            tp.style.height = '100%';
        }
        if (term) term.resize();
    }

    function saveCode(value) {
        try {
            const ed = getActiveEditor();
            localStorage.setItem('basic_editor_code', value ?? (ed ? ed.value : ''));
        } catch(e) {}
    }
    function loadCode() {
        try { return localStorage.getItem('basic_editor_code'); } catch(e) { return null; }
    }

    function saveSettings(obj) {
        try { localStorage.setItem('basic_settings', JSON.stringify(obj)); } catch(e) {}
    }
    function loadSettings() {
        try { return JSON.parse(localStorage.getItem('basic_settings') || '{}'); } catch(e) { return {}; }
    }

    function applySettings(s) {
        if (s.editor) {
            document.querySelectorAll('.editor-textarea, #editor').forEach(editor=>{
                if (s.editor.fontFamily) editor.style.fontFamily = s.editor.fontFamily + ", monospace";
                if (s.editor.fontSize) editor.style.fontSize = s.editor.fontSize + 'px';
                if (s.editor.color) editor.style.color = s.editor.color;
                if (s.editor.bg) editor.style.backgroundColor = s.editor.bg;
            });
        }
        if (s.terminal) {
            const fam = s.terminal.fontFamily ? (s.terminal.fontFamily + ", monospace") : null;
            const size = s.terminal.fontSize ? (s.terminal.fontSize + 'px') : null;
            if (fam) { $('#terminal, #terminal .terminal').css('font-family', fam); }
            if (size) { $('#terminal, #terminal .terminal').css('font-size', size); }
            if (term) term.resize();
        }
    }

    function openMenuById(id) {
        const trigger = document.getElementById(id);
        if (!trigger) return;
        const dd = bootstrap.Dropdown.getOrCreateInstance(trigger);
        dd.show();
        currentMenu = dd;
        // focus the trigger to direct subsequent keystrokes
        trigger.focus();
    }
    function closeCurrentMenu() {
        if (currentMenu) { currentMenu.hide(); currentMenu = null; }
    }

    // --- VFS integration and File menu actions ---
    function menuAction(action) {
        switch(action) {
            case 'file-new':
                onFileNew();
                break;
            case 'file-open':
                if (tabs.length >= MAX_TABS) { alert(`You have reached the tab limit (${MAX_TABS}). Close a tab to open another.`); }
                else { showOpenDialog(); }
                break;
            case 'file-save':
                onFileSave();
                break;
            case 'file-saveas':
                showSaveAsDialog();
                break;
            case 'file-close':
                onFileCloseTab();
                break;
            case 'proj-new':
                ProjectManager && ProjectManager.init && ProjectManager.init(vfs);
                ProjectManager.newProjectPrompt();
                break;
            case 'proj-open':
                ProjectManager && ProjectManager.init && ProjectManager.init(vfs);
                ProjectManager.openProjectPrompt();
                break;
            case 'proj-close':
                ProjectManager && ProjectManager.closeProject && ProjectManager.closeProject();
                break;
            case 'tool-1':
                alert('Menu item Tool 1 goes here');
                break;
            case 'tool-2':
                alert('Menu item Tool 2 goes here');
                break;
            case 'tool-3':
                alert('Menu item Tool 3 goes here');
                break;
            case 'help-1':
                alert('Menu item Help 1 goes here');
                break;
            case 'help-2':
                alert('Menu item Help 2 goes here');
                break;
            case 'help-3':
                alert('Menu item Help 3 goes here');
                break;
            case 'about':
                const about = new bootstrap.Modal(document.getElementById('modalAbout'));
                about.show();
                break;
        }
    }

    function openEditor(suppressAutoload) {
        const pane = document.getElementById('editor-pane');
        const wasHidden = pane.classList.contains('d-none');
        pane.classList.remove('d-none');
        setNavHeight();
        // Optionally preload Hello World only on first reveal and only for first tab when empty
        if (!suppressAutoload && wasHidden){
            const first = getTabById(0);
            if (first && (first.textarea.value || '').trim() === ''){
                let code = loadCode();
                if (!code || code.trim().length === 0) {
                    code = 'PRINTLN "Hello World"\n';
                }
                first.textarea.value = code; // only overwrite the first time we open in this session
                setTabTitle(0, 'Untitled', 'Untitled');
            }
        }
        const ed = getActiveEditor();
        if (ed) setTimeout(() => ed.focus(), 0);
    }

    function closeEditor(clear) {
        if (clear) {
            const ed = getActiveEditor();
            if (ed) { ed.value = ''; saveCode(''); }
        }
        document.getElementById('editor-pane').classList.add('d-none');
        setNavHeight();
        // reset current file state when closing
        currentFileName = null; currentFileReadOnly = false;
        // return focus to terminal
        if (term) setTimeout(() => term.focus(true), 0);
    }

    function runProgram() {
        // Pass VFS to interpreter before running
        if (basic) basic.vfs = vfs;
        const ed = getActiveEditor();
        const code = ed ? (ed.value || '') : '';
        if (!term) return;
        if (code.trim().length === 0) return;
        // Execute whole program using interpreter's runProgram to support control blocks
        basic.setTerm(term);
        try {
            const outLines = basic.runProgram(code);
            if (outLines && outLines.length) {
                outLines.forEach(l => { if (l && l.length) term.echo(l); });
            }
        } catch(e) {
            term.error(String(e && e.message ? e.message : e));
        }
        term.focus(true);
    }

    function toggleDebug() {
        debugOn = !debugOn;
        const cmd = debugOn ? 'DEBUGON' : 'DEBUGOFF';
        term.exec(cmd);
    }
    function toggleClear() {
        const cmd = 'clear';
        term.exec(cmd);
    }

    // Wire DOM
    $(function(){
        // Instantiate VFS and expose globally
        vfs = new VirtualFileSystem({ localStorageKey: 'yobasic.vfs' });
        vfs.loadFromLocalStorage();
        window.__vfsInstance__ = vfs;
        // Set up Supabase-backed providers
        (async ()=>{
            try{
                // Attempt to initialize Supabase (will noop if not configured)
                await getSupabase();
                const examplesProvider = new SupabaseExamplesProvider();
                const sharedProvider = new SupabaseSharedProvider(Identity);
                vfs.setProviders({ examples: examplesProvider, shared: sharedProvider });
                await Identity.initializeFromSession();
                updateIdentityUi();
                // After providers are ready, try loading sharedProject from URL
                try{ await tryLoadSharedProjectFromUrl(); }catch(err){ console.warn('sharedProject load failed', err); }
            }catch(e){ console.warn('[YoBASIC] Supabase init failed', e); }
        })();

        // Host bridge (Phase 3 addendum)
        window.YoBasicHost = window.YoBasicHost || {
            showModal: function(html){
                // Create/reuse a bootstrap modal container
                let host = document.getElementById('modalHost');
                if (!host){
                    host = document.createElement('div');
                    host.id = 'modalHost';
                    host.className = 'modal fade';
                    host.tabIndex = -1;
                    host.innerHTML = [
                        '<div class="modal-dialog modal-lg modal-dialog-centered">',
                        '  <div class="modal-content bg-dark text-light">',
                        '    <div class="modal-header">',
                        '      <h5 class="modal-title">View</h5>',
                        '      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>',
                        '    </div>',
                        '    <div class="modal-body"><div id="modalHostBody"></div></div>',
                        '    <div class="modal-footer">',
                        '      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>',
                        '    </div>',
                        '  </div>',
                        '</div>'
                    ].join('');
                    document.body.appendChild(host);
                }
                const body = host.querySelector('#modalHostBody');
                if (body){ body.innerHTML = String(html || ''); }
                // Bind click handlers: id -> id_click
                try{
                    const container = body || host;
                    const clickable = container.querySelectorAll('[id]');
                    clickable.forEach(el=>{
                        const id = el.id;
                        if (!id) return;
                        const handlerName = (id + '_click').toLowerCase();
                        el.addEventListener('click', function(){
                            try{
                                if (window.ProjectManager && typeof ProjectManager.callAny === 'function'){
                                    ProjectManager.callAny(handlerName, []);
                                } else {
                                    console.warn('[YoBASIC] ProjectManager not ready for handler', handlerName);
                                }
                            }catch(e){ console.warn('[YoBASIC] handler error', handlerName, e); }
                        });
                    });
                }catch(e){ console.warn('Bind handlers failed', e); }
                const modal = bootstrap.Modal.getOrCreateInstance(host);
                modal.show();
                return '';
            }
        };
        function hostReadFile(path){
            const p = String(path||'');
            const absPrefixes = ['projects/','shared/','examples/','data/','/'];
            let full = p;
            if (!absPrefixes.some(pre=>p.toLowerCase().startsWith(pre))){
                // Resolve relative to current project if available
                const proj = (window.ProjectManager && ProjectManager.getCurrentProjectName && ProjectManager.getCurrentProjectName()) || null;
                if (proj){
                    full = `projects/${proj}/${p}`;
                } else {
                    // No project context yet; return empty per addendum option
                    return '';
                }
            }
            // Use synchronous VFS getFile when possible
            const f = vfs && vfs.getFile ? vfs.getFile(full) : null;
            if (f && typeof f.content === 'string') return f.content;
            // Fallback to data read for data/
            if (vfs && full.toLowerCase().startsWith('data/')){
                const d = vfs.readData(full);
                return d != null ? String(d) : '';
            }
            return '';
        }
        function hostExtern(name, args){
            try{
                const fn = window.YoBasicHost && window.YoBasicHost[name];
                if (typeof fn === 'function'){
                    const res = fn.apply(window.YoBasicHost, args || []);
                    return (typeof res === 'string') ? res : '';
                }
                console.warn('[YoBASIC] Unknown host method', name);
                return '';
            }catch(e){ console.warn('[YoBASIC] hostExtern error', e); return ''; }
        }
        function hostCallModule(moduleName, memberName, args){
            // Delegate dotted calls to the current project's modules when available
            try{
                if (window.ProjectManager && typeof ProjectManager.callModule === 'function' && ProjectManager.getCurrentProjectName && ProjectManager.getCurrentProjectName()){
                    return ProjectManager.callModule(moduleName, memberName, args || []);
                }
            }catch(e){ throw e; }
            throw new Error('Unknown module: ' + moduleName);
        }

        // Initialize terminal in dedicated div
        basic = new BasicInterpreter({ term: null, autoEcho: false, debug: true, vfs, hostReadFile, hostExtern, hostCallModule });
        term = $('#terminal').terminal(function(command) {
            if (command !== '') {
                try {
                    basic.setTerm(term);
                    var out = basic.lineExecute(command);
                    if (out) {
                        String(out).split(/\n/).forEach(line => { if (line.length) this.echo(line); });
                    }
                } catch(e) {
                    this.error(new String(e));
                }
            }
        }, {
            greetings: 'ðŸŒ±YoBASIC v1.0 by Blackrush, LLC\nCopyright (C) 1981-2025\nTRACE is ON (TRON).',
            name: 'js_demo',
            prompt: "\nOK\n\n"
        });
        window.term = term;

        // Height + focus
        setNavHeight();
        window.addEventListener('resize', setNavHeight);
        // Default: focus terminal
        term.focus(true);

        // Restore settings
        const settings = loadSettings();
        // populate settings UI
        $('#editor-font').val(settings.editor?.fontFamily || 'Courier New');
        $('#editor-size').val(settings.editor?.fontSize || 16);
        $('#editor-color').val(settings.editor?.color || '#e6f0ff');
        $('#editor-bg').val(settings.editor?.bg || '#031634');
        $('#terminal-font').val(settings.terminal?.fontFamily || 'Courier New');
        $('#terminal-size').val(settings.terminal?.fontSize || 16);
        applySettings(settings);

        // Autosave editor content
        buildInitialTabUi();
        $('#editor').on('input', function(){ saveCode(this.value); });

        // Menu item clicks
        $('.dropdown-item').on('click', function(e){ e.preventDefault(); const action = this.dataset.action; closeCurrentMenu(); menuAction(action); });

        // Open dialog interactions
        $('#open-folders').on('click', '.list-group-item[data-folder]', function(){
            $('#open-folders .list-group-item').removeClass('active');
            $(this).addClass('active');
            renderOpenFiles($(this).data('folder'));
        });
        $('#open-files').on('click', '.list-group-item', function(){
            $('#open-files .list-group-item').removeClass('active');
            $(this).addClass('active');
            $('#btn-open-ok').prop('disabled', false);
        });
        $('#open-files').on('dblclick', '.list-group-item', function(){ $('#btn-open-ok').trigger('click'); });
        $('#btn-open-ok').on('click', async function(){
            const $sel = $('#open-files .list-group-item.active');
            if ($sel.length === 0) return;
            if (tabs.length >= MAX_TABS){ alert(`You have reached the tab limit (${MAX_TABS}). Close a tab to open another.`); return; }
            const fullName = $sel.data('fullname');
            const isRemote = /^examples\//i.test(fullName) || /^shared\//i.test(fullName);
            const file = isRemote ? (await vfs.getFileAsync(fullName)) : vfs.getFile(fullName);
            if (!file) return;
            const displayName = fullName.includes('/') ? fullName.split('/').pop() : fullName;
            createNewTab({
                content: file.content || '',
                fullName: file.name,
                readOnly: !!file.readOnly,
                displayName
            });
            bootstrap.Modal.getOrCreateInstance(document.getElementById('modalOpen')).hide();
        });

        // Save As dialog interactions
        $('#save-folders').on('click', '.list-group-item', function(){
            // Only Root enabled for saving program files now
            $('#save-folders .list-group-item').removeClass('active');
            $(this).addClass('active');
            renderSaveFiles($(this).data('folder'));
        });
        $('#save-files').on('click', '.list-group-item', function(){
            $('#save-files .list-group-item').removeClass('active');
            $(this).addClass('active');
            const name = $(this).data('fullname');
            const folderBtn = document.querySelector('#save-folders .list-group-item.active');
            const folder = folderBtn ? folderBtn.getAttribute('data-folder') : 'Root';
            if (folder === 'projects'){
                const proj = (window.ProjectManager && ProjectManager.getCurrentProjectName && ProjectManager.getCurrentProjectName()) || null;
                const prefix = proj ? (`projects/${proj}/`) : null;
                if (proj && String(name).toLowerCase().startsWith(prefix.toLowerCase())){
                    $('#saveas-name').val(name.slice(prefix.length));
                    return;
                }
            }
            $('#saveas-name').val(name);
        });
        $('#btn-saveas-ok').on('click', function(){ doSaveAs(); });

        // Toolbar buttons
        $('#btn-run').on('click', function(){ runProgram(); });
        $('#btn-bug').on('click', function(){ toggleDebug(); });
        $('#btn-clear').on('click', function(){ toggleClear(); });
        $('#btn-build').on('click', async function(){
            try{
                ProjectManager && ProjectManager.init && ProjectManager.init(vfs);
                await ProjectManager.buildCurrent();
            }catch(e){ alert(String(e && e.message ? e.message : e)); }
        });
        $('#btn-settings').on('click', function(){ new bootstrap.Modal(document.getElementById('modalSettings')).show(); });

        // Save settings
        $('#btn-save-settings').on('click', function(){
            const s = {
                editor: {
                    fontFamily: $('#editor-font').val(),
                    fontSize: parseInt($('#editor-size').val(), 10) || 16,
                    color: $('#editor-color').val(),
                    bg: $('#editor-bg').val()
                },
                terminal: {
                    fontFamily: $('#terminal-font').val(),
                    fontSize: parseInt($('#terminal-size').val(), 10) || 16
                }
            };
            saveSettings(s);
            applySettings(s);
        });

        // Identity button
        $('#btn-identity').on('click', function(){
            updateIdentityUi();
            new bootstrap.Modal(document.getElementById('modalIdentity')).show();
        });
        // Identity actions
        $('#btn-login').on('click', async function(){
            const u = $('#login-username').val().trim();
            const p = $('#login-password').val();
            try{
                await Identity.login(u, p);
                updateIdentityUi();
                bootstrap.Modal.getOrCreateInstance(document.getElementById('modalIdentity')).hide();
                term && term.echo && term.echo('[Logged in] ' + Identity.getCurrentUser().username);
            }catch(e){ alert(String(e.message || e)); }
        });
        $('#btn-signup').on('click', async function(){
            const u = $('#signup-username').val().trim();
            const e = $('#signup-email').val().trim();
            const p = $('#signup-password').val();
            try{
                const res = await Identity.signup(u, e, p);
                if (res && res.needsConfirmation){
                    alert('Check your email (' + e + ') and confirm your address, then return here to Log In.');
                    // Switch to Login tab and prefill with email
                    const loginTabBtn = document.getElementById('tab-login-tab');
                    if (loginTabBtn){
                        // Bootstrap 5 Tab API
                        if (bootstrap && bootstrap.Tab){ bootstrap.Tab.getOrCreateInstance(loginTabBtn).show(); }
                        else { loginTabBtn.click(); }
                    }
                    $('#login-username').val(e);
                    return;
                }
                updateIdentityUi();
                bootstrap.Modal.getOrCreateInstance(document.getElementById('modalIdentity')).hide();
                term && term.echo && term.echo('[Identity created] ' + (Identity.getCurrentUser()?.username || u));
            }catch(e){ alert(String(e.message || e)); }
        });
        $('#btn-logout').on('click', async function(){
            try{ await Identity.logout(); updateIdentityUi(); }
            catch(e){}
            bootstrap.Modal.getOrCreateInstance(document.getElementById('modalIdentity')).hide();
            term && term.echo && term.echo('[Logged out]');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e){
            // Open menus with Alt+F/T/H
            if (e.altKey && !e.ctrlKey && !e.metaKey) {
                const k = e.key.toLowerCase();
                if (k === 'f') { e.preventDefault(); openMenuById('menu-file'); return; }
                if (k === 't') { e.preventDefault(); openMenuById('menu-tools'); return; }
                if (k === 'h') { e.preventDefault(); openMenuById('menu-help'); return; }
            }
            // Ctrl+S shortcut to Save
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); onFileSave(); return; }
            // If a dropdown is open, handle hotkeys for items
            if (currentMenu) {
                const k = e.key.toLowerCase();
                if (/^[a-z0-9]$/.test(k)) {
                    e.preventDefault();
                    const trigger = currentMenu._element; // anchor
                    const menuId = trigger.getAttribute('aria-controls') || trigger.getAttribute('data-bs-target');
                    // find menu via nextElementSibling (Bootstrap renders immediately after trigger)
                    const menu = trigger.nextElementSibling?.classList.contains('dropdown-menu') ? trigger.nextElementSibling : null;
                    if (menu) {
                        const item = menu.querySelector(`[data-key="${k}"]`);
                        if (item) { item.click(); }
                    }
                }
                if (e.key === 'Escape') { closeCurrentMenu(); }
            }
        }, true);
    });

    function updateIdentityUi(){
        const me = Identity.getCurrentUser && Identity.getCurrentUser();
        if (me){
            $('#identity-status').text(`You are logged in as ${me.username}.`);
            $('#identity-forms').addClass('d-none');
            $('#identity-loggedin').removeClass('d-none');
            $('#whoami').text(me.username);
            $('#identity-label').text(me.username);
            // Enable Shared in Save As
            $('#save-folders [data-folder="shared"]').prop('disabled', false);
        } else {
            $('#identity-status').text('You are not logged in.');
            $('#identity-forms').removeClass('d-none');
            $('#identity-loggedin').addClass('d-none');
            $('#identity-label').text('Login');
            // Disable Shared in Save As (still visible for info)
            $('#save-folders [data-folder="shared"]').prop('disabled', false); // allow viewing guidance
        }
    }

    // --- Dialog helpers and file operations ---
    function labelForFile(f, opts){
        const name = String(f.name);
        const lower = name.toLowerCase();
        const ctx = opts || {};
        const ro = f.readOnly ? ' [RO]' : '';
        // Prefer showing a relative path within the selected namespace
        if (ctx.folder === 'projects'){
            // Show path after projects/<ProjectName>/
            const idx = lower.indexOf('projects/');
            if (idx === 0){
                const rest = name.slice(('projects/').length);
                const slash = rest.indexOf('/');
                if (slash >= 0){ return rest.slice(slash+1) + ro; }
                return rest + ro;
            }
        }
        if (ctx.folder === 'shared' && ctx.owner){
            const prefix = `shared/${ctx.owner}/`;
            if (lower.startsWith(prefix.toLowerCase())){
                return name.slice(prefix.length) + ro;
            }
        }
        if (lower.startsWith('shared/')){
            // default for shared without owner context: show owner/path
            return name.slice('shared/'.length) + ro;
        }
        if (lower.startsWith('examples/')){
            return name.slice('examples/'.length) + ro;
        }
        if (lower.startsWith('data/')){
            return name.slice('data/'.length) + ro;
        }
        // Root fallback: show base name
        return (name.includes('/') ? name.split('/').pop() : name) + ro;
    }
    async function renderOpenFiles(folder){
        const list = $('#open-files').empty();
        if (folder === 'shared'){
            // show owners list in left column under folders
            await renderSharedOwners();
            // By default, do not list files until an owner is clicked
            list.append('<div class="list-group-item list-group-item-dark disabled">Select a user from the Shared list to view files.</div>');
            $('#btn-open-ok').prop('disabled', true);
            return;
        }
        if (folder === 'projects'){
            await renderProjectsPanel();
            list.append('<div class="list-group-item list-group-item-dark disabled">Select a project to view files.</div>');
            $('#btn-open-ok').prop('disabled', true);
            return;
        }
        // clear side panels when not browsing shared/projects
        if (folder !== 'shared'){ $('#open-shared-owners').empty(); }
        if (folder !== 'projects'){ $('#open-projects').empty(); }
        const isRemote = (folder === 'examples');
        const files = isRemote ? (await vfs.listByFolderAsync(folder)) : vfs.listByFolder(folder);
        list.empty();
        files.forEach(f => {
            const disabled = (folder === 'data' && f.kind !== 'data') ? ' disabled' : '';
            const $item = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark${disabled}" data-fullname="${f.name}">${labelForFile(f, { folder })}</button>`);
            list.append($item);
        });
        $('#btn-open-ok').prop('disabled', true);
    }
    async function renderProjectsPanel(){
        const c = $('#open-projects').empty();
        const names = getLocalProjectNames();
        if (!names.length){ c.append('<div class="text-secondary small">No local projects.</div>'); return; }
        c.append('<div class="small text-secondary">Projects</div>');
        names.forEach(name=>{
            const btn = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-project="${name}">projects/${name}</button>`);
            btn.on('click', function(){
                $('#open-projects .list-group-item').removeClass('active');
                $(this).addClass('active');
                const prefix = `projects/${name}/`;
                const files = vfs.listFiles().filter(f=>f.name.toLowerCase().startsWith(prefix.toLowerCase()));
                const list = $('#open-files').empty();
                files.forEach(f=>{
                    const $item = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-fullname="${f.name}">${labelForFile(f, { folder: 'projects' })}</button>`);
                    list.append($item);
                });
                $('#btn-open-ok').prop('disabled', true);
            });
            c.append(btn);
        });
    }
    function getLocalProjectNames(){
        const files = vfs.listFiles();
        const set = new Set();
        files.forEach(f=>{
            const n = f.name;
            if (n.toLowerCase().startsWith('projects/')){
                const rest = n.slice(9);
                const idx = rest.indexOf('/');
                if (idx > 0) set.add(rest.slice(0, idx));
            }
        });
        return Array.from(set.values()).sort();
    }
    async function renderSharedOwners(){
        const c = $('#open-shared-owners').empty();
        const prov = vfs && vfs.providers && vfs.providers.shared;
        if (!prov){ c.append('<div class="text-secondary small">Shared disabled.</div>'); return; }
        const owners = await (prov.listOwners ? prov.listOwners() : []);
        if (!owners.length){ c.append('<div class="text-secondary small">No shared users yet.</div>'); return; }
        c.append('<div class="small text-secondary">Users</div>');
        owners.forEach(owner=>{
            const btn = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-owner="${owner}">shared/${owner}</button>`);
            btn.on('click', async function(){
                $('#open-folders .list-group-item').removeClass('active');
                $(this).addClass('active');
                const files = await prov.listFilesForOwner(owner);
                const list = $('#open-files').empty();
                files.forEach(f=>{
                    const $item = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-fullname="${f.name}">${labelForFile(f, { folder: 'shared', owner: owner })}</button>`);
                    list.append($item);
                });
                $('#btn-open-ok').prop('disabled', true);
            });
            c.append(btn);
        });
    }
    async function renderSaveFiles(folder){
        const list = $('#save-files').empty();
        const help = $('#modalSaveAs .form-text');
        if (folder === 'shared'){
            help.text('Save into your shared folder as <name>.BAS');
            const me = Identity.getCurrentUser && Identity.getCurrentUser();
            if (!me){ list.append('<div class="list-group-item list-group-item-dark disabled">Log in to save to your shared folder.</div>'); return; }
            // list my existing shared files
            const prov = vfs && vfs.providers && vfs.providers.shared;
            if (!prov){ list.append('<div class="list-group-item list-group-item-dark disabled">Shared is not available.</div>'); return; }
            const files = await prov.listFilesForOwner(me.username);
            files.forEach(f=>{
                const $item = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-fullname="${f.name}">${labelForFile(f, { folder: 'shared', owner: me.username })}</button>`);
                list.append($item);
            });
            return;
        }
        if (folder === 'projects'){
            const proj = (window.ProjectManager && ProjectManager.getCurrentProjectName && ProjectManager.getCurrentProjectName()) || null;
            if (!proj){ help.text('Open a project to save files into it.'); list.append('<div class="list-group-item list-group-item-dark disabled">No project open.</div>'); return; }
            help.text(`Saving into projects/${proj}/... Enter a relative path like Modules/NEW.BAS`);
            const prefix = `projects/${proj}/`;
            const files = vfs.listFiles().filter(f=>f.name.toLowerCase().startsWith(prefix.toLowerCase()));
            files.forEach(f=>{
                const $item = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-fullname="${f.name}">${labelForFile(f, { folder: 'projects' })}</button>`);
                list.append($item);
            });
            return;
        }
        // Root
        help.text('Programs are saved in Root as .BAS files.');
        const files = vfs.listByFolder('Root').filter(f=>f.kind==='program');
        files.forEach(f => {
            const $item = $(`<button type="button" class="list-group-item list-group-item-action list-group-item-dark" data-fullname="${f.name}">${labelForFile(f)}</button>`);
            list.append($item);
        });
    }
    function showOpenDialog(){
        renderOpenFiles('Root');
        const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('modalOpen'));
        m.show();
    }
    function showSaveAsDialog(){
        $('#saveas-name').val(currentFileName && !currentFileReadOnly ? (currentFileName.includes('/')? currentFileName.split('/').pop() : currentFileName) : '');
        renderSaveFiles('Root');
        const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('modalSaveAs'));
        m.show();
        setTimeout(()=>document.getElementById('saveas-name').focus(), 0);
    }
    function normalizeBasName(name){
        let n = String(name||'').trim();
        if (n.length === 0) return null;
        if (!/\.bas$/i.test(n)) n += '.BAS';
        return n;
    }
    function onFileCloseTab(){
        closeTab(activeTabId);
    }
    function onFileNew(){
        if (tabs.length >= MAX_TABS){
            alert(`You have reached the tab limit (${MAX_TABS}). Close a tab to add another.`);
            return;
        }
        createNewTab({ content: '', displayName: 'Untitled' });
        const tab = getActiveTab();
        if (tab){ tab.fullName = null; tab.readOnly = false; }
        saveCode('');
    }
    async function onFileSave(){
        // Direct save if current file exists and is writable
        if (currentFileName && !currentFileReadOnly){
            const ed = getActiveEditor();
            const content = ed ? (ed.value || '') : '';
            if (/^shared\//i.test(currentFileName)){
                await vfs.writeProgramAsync(currentFileName, content);
            } else {
                vfs.writeProgram(currentFileName, content);
                vfs.saveToLocalStorage();
            }
            // keep tab title consistent
            const base = currentFileName.includes('/') ? currentFileName.split('/').pop() : currentFileName;
            setTabTitle(activeTabId, base, currentFileName);
            const t = getActiveTab(); if (t){ t.fullName = currentFileName; t.readOnly = false; }
            term && term.echo && term.echo('[Saved] ' + currentFileName);
            return;
        }
        // Otherwise Save As
        showSaveAsDialog();
    }
    async function doSaveAs(){
        const folderBtn = document.querySelector('#save-folders .list-group-item.active');
        const folder = folderBtn ? folderBtn.getAttribute('data-folder') : 'Root';
        const nameInput = document.getElementById('saveas-name');
        const normalizedBase = normalizeBasName(nameInput.value);
        if (!normalizedBase){ alert('Please enter a file name.'); return; }
        let targetName = normalizedBase;
        if (folder === 'shared'){
            const me = Identity.getCurrentUser && Identity.getCurrentUser();
            if (!me){ alert('Log in to save to Shared.'); return; }
            targetName = `shared/${me.username}/${normalizedBase}`;
        } else if (folder === 'projects'){
            const proj = (window.ProjectManager && ProjectManager.getCurrentProjectName && ProjectManager.getCurrentProjectName()) || null;
            if (!proj){ alert('Open a project to save into it.'); return; }
            // Allow entering relative path like Menus/NEW.BAS, Modules/X.BAS, Views/Y.html
            const rel = nameInput.value.trim();
            if (!rel){ alert('Enter a relative path within the project, e.g., Modules/NEW.BAS'); return; }
            targetName = `projects/${proj}/${rel}`;
        } else if (folder !== 'Root'){
            alert('Choose Root, Projects, or Shared to save program files.');
            return;
        }
        // Check existing (local for Root/Projects, remote for Shared)
        let existing = null;
        if (/^shared\//i.test(targetName)){
            existing = await vfs.getFileAsync(targetName);
        } else {
            existing = vfs.getFile(targetName);
        }
        if (existing){
            if (existing.readOnly){ alert('This file is read-only. Use a different name.'); return; }
            if (!confirm('File already exists. Overwrite?')) return;
        }
        const ed = getActiveEditor();
        const content = ed ? (ed.value || '') : '';
        const isBas = /\.bas$/i.test(targetName);
        if (/^shared\//i.test(targetName)){
            if (isBas){
                await vfs.writeProgramAsync(targetName, content);
            } else {
                await vfs.writeFileAsync(targetName, content, 'data');
            }
            currentFileName = targetName; currentFileReadOnly = false;
        } else {
            if (isBas){ vfs.writeProgram(targetName, content); }
            else { vfs.writeFile(targetName, content, 'data'); }
            vfs.saveToLocalStorage();
            currentFileName = targetName; currentFileReadOnly = false;
        }
        // Update tab metadata and title/tooltip
        const base = targetName.includes('/') ? targetName.split('/').pop() : targetName;
        setTabTitle(activeTabId, base, targetName);
        const t = getActiveTab(); if (t){ t.fullName = targetName; t.readOnly = false; }
        bootstrap.Modal.getOrCreateInstance(document.getElementById('modalSaveAs')).hide();
        term && term.echo && term.echo('[Saved] ' + targetName);
    }
    // --- Slide-out Drawers (Left: Files/Watch/Message, Right: Home docs) ---
    // Adjustable widths: tweak the CSS variables below or in the added <style> tag.
    const DRAWERS = {
        leftOpen: false,
        rightOpen: false
    };
    function isAnyModalOpen(){ return !!document.querySelector('.modal.show'); }
    function toggleLeftDrawer(force){
        const el = document.getElementById('left-drawer');
        if (!el) return;
        const open = (typeof force === 'boolean') ? force : !DRAWERS.leftOpen;
        DRAWERS.leftOpen = open;
        el.classList.toggle('open', open);
        document.getElementById('toggle-left-drawer')?.setAttribute('aria-expanded', String(open));
    }
    function toggleRightDrawer(force){
        const el = document.getElementById('right-drawer');
        if (!el) return;
        const open = (typeof force === 'boolean') ? force : !DRAWERS.rightOpen;
        DRAWERS.rightOpen = open;
        el.classList.toggle('open', open);
        document.getElementById('toggle-right-drawer')?.setAttribute('aria-expanded', String(open));
    }
    function closeDrawers(){ toggleLeftDrawer(false); toggleRightDrawer(false); }

    // --- VFS Tree (Files) ---
    function listLocalProjectNames(){
        const files = vfs.listFiles();
        const set = new Set();
        files.forEach(f=>{
            const n = f.name;
            if (n.toLowerCase().startsWith('projects/')){
                const rest = n.slice(9);
                const idx = rest.indexOf('/');
                if (idx > 0) set.add(rest.slice(0, idx));
            }
        });
        return Array.from(set.values()).sort();
    }
    function nestFiles(files, stripPrefix){
        const root = { dirs: {}, files: [] };
        files.forEach(f=>{
            let rest = f.name;
            if (stripPrefix && rest.toLowerCase().startsWith(stripPrefix.toLowerCase())){
                rest = rest.slice(stripPrefix.length);
            }
            const parts = rest.split('/');
            if (parts.length === 1){
                root.files.push({ file: f, label: parts[0] });
            } else {
                let cur = root;
                for (let i=0;i<parts.length-1;i++){
                    const seg = parts[i];
                    if (!cur.dirs[seg]) cur.dirs[seg] = { dirs:{}, files:[] };
                    cur = cur.dirs[seg];
                }
                cur.files.push({ file: f, label: parts[parts.length-1] });
            }
        });
        return root;
    }
    function renderTreeNode(name, data, basePath){
        const li = document.createElement('li'); li.className = 'vfs-node folder';
        const head = document.createElement('div'); head.className = 'vfs-row';
        const caret = document.createElement('i'); caret.className = 'bi bi-chevron-right vfs-caret';
        const label = document.createElement('span'); label.className = 'vfs-label'; label.textContent = name;
        head.appendChild(caret); head.appendChild(label);
        li.appendChild(head);
        const ul = document.createElement('ul'); ul.className = 'vfs-children'; ul.style.display = 'none';
        // subdirs
        Object.keys(data.dirs).sort().forEach(dn=>{
            const child = renderTreeNode(dn, data.dirs[dn], basePath ? (basePath + dn + '/') : (dn + '/'));
            ul.appendChild(child);
        });
        // files
        data.files.sort((a,b)=>a.label.localeCompare(b.label)).forEach(it=>{
            const fli = document.createElement('li'); fli.className='vfs-node file';
            const row = document.createElement('div'); row.className='vfs-row';
            const icon = document.createElement('i'); icon.className='bi bi-file-earmark-text';
            const lab = document.createElement('span'); lab.className='vfs-label'; lab.textContent = it.label;
            row.appendChild(icon); row.appendChild(lab); fli.appendChild(row);
            fli.dataset.fullname = it.file.name;
            ul.appendChild(fli);
        });
        li.appendChild(ul);
        head.addEventListener('click', function(){
            const open = ul.style.display !== 'none';
            ul.style.display = open ? 'none' : '';
            caret.className = open ? 'bi bi-chevron-right vfs-caret' : 'bi bi-chevron-down vfs-caret';
        });
        return li;
    }
    async function buildVfsTree(){
        const c = document.getElementById('vfs-tree'); if (!c) return;
        c.innerHTML = '';
        const rootUl = document.createElement('ul'); rootUl.className='vfs-root';
        // Root node (expanded by default)
        const rootLi = document.createElement('li'); rootLi.className='vfs-node folder expanded';
        const head = document.createElement('div'); head.className='vfs-row';
        const caret = document.createElement('i'); caret.className='bi bi-chevron-down vfs-caret';
        const label = document.createElement('span'); label.className='vfs-label'; label.textContent='Root';
        head.appendChild(caret); head.appendChild(label); rootLi.appendChild(head);
        const rootChildren = document.createElement('ul'); rootChildren.className='vfs-children';
        // Root files at top level
        const rootFilesNest = nestFiles(vfs.listByFolder('Root'), '');
        rootFilesNest.files.forEach(it=>{
            const fli = document.createElement('li'); fli.className='vfs-node file';
            const row = document.createElement('div'); row.className='vfs-row';
            const icon = document.createElement('i'); icon.className='bi bi-file-earmark-text';
            const lab = document.createElement('span'); lab.className='vfs-label'; lab.textContent = it.label;
            row.appendChild(icon); row.appendChild(lab); fli.appendChild(row);
            fli.dataset.fullname = it.file.name;
            rootChildren.appendChild(fli);
        });
        // Projects folder
        const projContainer = document.createElement('li'); projContainer.className='vfs-node folder';
        const projHead = document.createElement('div'); projHead.className='vfs-row';
        const projCaret = document.createElement('i'); projCaret.className='bi bi-chevron-right vfs-caret';
        const projLabel = document.createElement('span'); projLabel.className='vfs-label'; projLabel.textContent='projects';
        projHead.appendChild(projCaret); projHead.appendChild(projLabel); projContainer.appendChild(projHead);
        const projChildren = document.createElement('ul'); projChildren.className='vfs-children'; projChildren.style.display='none';
        const projectNames = listLocalProjectNames();
        if (projectNames.length === 0){
            const placeholder = document.createElement('li'); placeholder.className='vfs-placeholder';
            placeholder.title = 'Create a new Project from the File Menu';
            placeholder.textContent = 'Create a new Project from the File Menu';
            projChildren.appendChild(placeholder);
        } else {
            // Build nested tree of all project files after 'projects/'
            const allProjFiles = vfs.listFiles().filter(f=>f.name.toLowerCase().startsWith('projects/'));
            const projNest = nestFiles(allProjFiles, 'projects/');
            Object.keys(projNest.dirs).sort().forEach(pn=>{
                const li = renderTreeNode(pn, projNest.dirs[pn], 'projects/' + pn + '/');
                projChildren.appendChild(li);
            });
        }
        projContainer.appendChild(projChildren);
        projHead.addEventListener('click', function(){
            const open = projChildren.style.display !== 'none';
            projChildren.style.display = open ? 'none' : '';
            projCaret.className = open ? 'bi bi-chevron-right vfs-caret' : 'bi bi-chevron-down vfs-caret';
        });
        rootChildren.appendChild(projContainer);
        // Examples folder
        const exLi = document.createElement('li'); exLi.className='vfs-node folder';
        const exHead = document.createElement('div'); exHead.className='vfs-row';
        const exCaret = document.createElement('i'); exCaret.className='bi bi-chevron-right vfs-caret';
        const exLabel = document.createElement('span'); exLabel.className='vfs-label'; exLabel.textContent='examples';
        exHead.appendChild(exCaret); exHead.appendChild(exLabel); exLi.appendChild(exHead);
        const exChildren = document.createElement('ul'); exChildren.className='vfs-children'; exChildren.style.display='none';
        try{
            const exFiles = await vfs.listByFolderAsync('examples');
            const exNest = nestFiles(exFiles, 'examples/');
            Object.keys(exNest.dirs).sort().forEach(dn=>{
                const li = renderTreeNode(dn, exNest.dirs[dn], 'examples/' + dn + '/');
                exChildren.appendChild(li);
            });
            exNest.files.forEach(it=>{
                const fli = document.createElement('li'); fli.className='vfs-node file';
                const row = document.createElement('div'); row.className='vfs-row';
                const icon = document.createElement('i'); icon.className='bi bi-file-earmark-text';
                const lab = document.createElement('span'); lab.className='vfs-label'; lab.textContent = it.label;
                row.appendChild(icon); row.appendChild(lab); fli.appendChild(row);
                fli.dataset.fullname = it.file.name;
                exChildren.appendChild(fli);
            });
        }catch(_){ /* ignore */ }
        exLi.appendChild(exChildren);
        exHead.addEventListener('click', function(){
            const open = exChildren.style.display !== 'none';
            exChildren.style.display = open ? 'none' : '';
            exCaret.className = open ? 'bi bi-chevron-right vfs-caret' : 'bi bi-chevron-down vfs-caret';
        });
        rootChildren.appendChild(exLi);
        // Data folder
        const dataLi = document.createElement('li'); dataLi.className='vfs-node folder';
        const dataHead = document.createElement('div'); dataHead.className='vfs-row';
        const dataCaret = document.createElement('i'); dataCaret.className='bi bi-chevron-right vfs-caret';
        const dataLabel = document.createElement('span'); dataLabel.className='vfs-label'; dataLabel.textContent='data';
        dataHead.appendChild(dataCaret); dataHead.appendChild(dataLabel); dataLi.appendChild(dataHead);
        const dataChildren = document.createElement('ul'); dataChildren.className='vfs-children'; dataChildren.style.display='none';
        const dataNest = nestFiles(vfs.listByFolder('data'), 'data/');
        Object.keys(dataNest.dirs).sort().forEach(dn=>{
            const li = renderTreeNode(dn, dataNest.dirs[dn], 'data/' + dn + '/');
            dataChildren.appendChild(li);
        });
        dataNest.files.forEach(it=>{
            const fli = document.createElement('li'); fli.className='vfs-node file';
            const row = document.createElement('div'); row.className='vfs-row';
            const icon = document.createElement('i'); icon.className='bi bi-file-earmark-text';
            const lab = document.createElement('span'); lab.className='vfs-label'; lab.textContent = it.label;
            row.appendChild(icon); row.appendChild(lab); fli.appendChild(row);
            fli.dataset.fullname = it.file.name;
            dataChildren.appendChild(fli);
        });
        dataLi.appendChild(dataChildren);
        dataHead.addEventListener('click', function(){
            const open = dataChildren.style.display !== 'none';
            dataChildren.style.display = open ? 'none' : '';
            dataCaret.className = open ? 'bi bi-chevron-right vfs-caret' : 'bi bi-chevron-down vfs-caret';
        });
        rootChildren.appendChild(dataLi);
        // Shared folder
        const shLi = document.createElement('li'); shLi.className='vfs-node folder';
        const shHead = document.createElement('div'); shHead.className='vfs-row';
        const shCaret = document.createElement('i'); shCaret.className='bi bi-chevron-right vfs-caret';
        const shLabel = document.createElement('span'); shLabel.className='vfs-label'; shLabel.textContent='shared';
        shHead.appendChild(shCaret); shHead.appendChild(shLabel); shLi.appendChild(shHead);
        const shChildren = document.createElement('ul'); shChildren.className='vfs-children'; shChildren.style.display='none';
        try{
            const shFiles = await vfs.listByFolderAsync('shared');
            const shNest = nestFiles(shFiles, 'shared/');
            Object.keys(shNest.dirs).sort().forEach(dn=>{
                const li = renderTreeNode(dn, shNest.dirs[dn], 'shared/' + dn + '/');
                shChildren.appendChild(li);
            });
            shNest.files.forEach(it=>{
                const fli = document.createElement('li'); fli.className='vfs-node file';
                const row = document.createElement('div'); row.className='vfs-row';
                const icon = document.createElement('i'); icon.className='bi bi-file-earmark-text';
                const lab = document.createElement('span'); lab.className='vfs-label'; lab.textContent = it.label;
                row.appendChild(icon); row.appendChild(lab); fli.appendChild(row);
                fli.dataset.fullname = it.file.name;
                shChildren.appendChild(fli);
            });
        }catch(_){ /* ignore */ }
        shLi.appendChild(shChildren);
        shHead.addEventListener('click', function(){
            const open = shChildren.style.display !== 'none';
            shChildren.style.display = open ? 'none' : '';
            shCaret.className = open ? 'bi bi-chevron-right vfs-caret' : 'bi bi-chevron-down vfs-caret';
        });
        rootChildren.appendChild(shLi);

        rootLi.appendChild(rootChildren); rootUl.appendChild(rootLi); c.appendChild(rootUl);
        // Click to open files
        c.addEventListener('click', async function(ev){
            const target = ev.target;
            const li = target && (target.closest('li.vfs-node.file'));
            if (!li) return;
            const fullName = li.dataset.fullname;
            if (!fullName) return;
            // Reuse open logic from Open dialog
            if (tabs.length >= MAX_TABS){ alert(`You have reached the tab limit (${MAX_TABS}). Close a tab to open another.`); return; }
            const isRemote = /^examples\//i.test(fullName) || /^shared\//i.test(fullName);
            const file = isRemote ? (await vfs.getFileAsync(fullName)) : vfs.getFile(fullName);
            if (!file) return;
            const displayName = fullName.includes('/') ? fullName.split('/').pop() : fullName;
            createNewTab({ content: file.content || '', fullName: file.name, readOnly: !!file.readOnly, displayName });
            openEditor(true);
        });
    }

    // Wire drawers after DOM ready (append listener at end of existing ready callback)
    $(function(){
        // Toggle buttons
        document.getElementById('toggle-left-drawer')?.addEventListener('click', function(){ toggleLeftDrawer(); });
        document.getElementById('toggle-right-drawer')?.addEventListener('click', function(){ toggleRightDrawer(); });
        document.getElementById('left-drawer-close')?.addEventListener('click', function(){ toggleLeftDrawer(false); });
        document.getElementById('right-drawer-close')?.addEventListener('click', function(){ toggleRightDrawer(false); });
        // Build initial tree
        try{ buildVfsTree(); }catch(e){ console.warn('VFS tree build failed', e); }
        // Extra global keyboard: F1 toggles right; F5 runs if editor focused; ESC closes drawers unless modal open
        document.addEventListener('keydown', function(e){
            const k = e.key;
            if (k === 'F1'){
                e.preventDefault(); // Always prevent default help
                toggleRightDrawer();
                return;
            }
            if (k === 'F5'){
                const ae = document.activeElement;
                if (ae && (ae.classList && ae.classList.contains('editor-textarea'))){
                    e.preventDefault();
                    runProgram();
                }
                return; // let browser handle otherwise
            }
            if (k === 'Escape'){
                if (!isAnyModalOpen()){
                    closeDrawers();
                }
            }
        }, true);
    });

})();
</script>

<!-- Slide-out Drawers Markup and Styles -->
<style id="drawers-style">
:root{ --left-drawer-width: 400px; /* adjust left drawer width here */ --right-drawer-width: 500px; /* adjust right drawer width here */ }
.drawer{ position: fixed; top: var(--nav-height); bottom: 0; background: #0f1f46; color: #e6f0ff; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 1040; transition: transform .2s ease-in-out; display: flex; flex-direction: column; }
.drawer .drawer-header{ display:flex; align-items:center; justify-content: space-between; padding: .5rem .75rem; background: #0a1633; border-bottom: 1px solid #1e2a55; }
.drawer .drawer-body{ overflow: auto; padding: .5rem .5rem; }
.drawer-left{ left: 0; width: var(--left-drawer-width); transform: translateX(calc(-1 * var(--left-drawer-width))); border-right: 1px solid #1e2a55; }
.drawer-left.open{ transform: translateX(0); }
.drawer-right{ right: 0; width: var(--right-drawer-width); transform: translateX(var(--right-drawer-width)); border-left: 1px solid #1e2a55; }
.drawer-right.open{ transform: translateX(0); }
.drawer-toggle{ position: fixed; top: calc(var(--nav-height) + 8px); padding: .25rem .5rem; z-index: 1041; border: 1px solid #1e2a55; background:#0a1633; color:#e6f0ff; border-radius: .25rem; }
.drawer-toggle.left{ left: 8px; }
.drawer-toggle.right{ right: 8px; }
/* VFS Tree styles */
.vfs-root, .vfs-children{ list-style: none; margin: 0; padding-left: .5rem; }
.vfs-node .vfs-row{ display:flex; align-items:center; gap:.35rem; padding:.1rem .25rem; user-select:none; cursor: default; }
.vfs-node.folder .vfs-row{ cursor: pointer; }
.vfs-node.file .vfs-row{ cursor: pointer; }
.vfs-node.file .vfs-row:hover{ background: rgba(255,255,255,0.08); }
.vfs-caret{ width: 1rem; text-align: center; }
.vfs-placeholder{ color: #9aa9c7; font-style: italic; padding: .1rem .25rem; }
/* Right drawer iframe */
#right-iframe{ width: 100%; height: 100%; border: 0; background: #fff; color: #000; }
</style>

<button id="toggle-left-drawer" class="drawer-toggle left" type="button" aria-expanded="false" title="Toggle Files">â˜°</button>
<button id="toggle-right-drawer" class="drawer-toggle right" type="button" aria-expanded="false" title="Toggle Home (F1)">âŒ˜</button>

<div id="left-drawer" class="drawer drawer-left" aria-label="Explorer">
  <div class="drawer-header">
    <div class="fw-bold">Explorer</div>
    <button id="left-drawer-close" class="btn btn-sm btn-outline-light">Close</button>
  </div>
  <div class="drawer-body">
    <div class="accordion" id="leftAccordion">
      <div class="accordion-item bg-transparent text-light border-secondary">
        <h2 class="accordion-header" id="acc-files-h">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#acc-files" aria-expanded="true" aria-controls="acc-files">Files</button>
        </h2>
        <div id="acc-files" class="accordion-collapse collapse show" aria-labelledby="acc-files-h" data-bs-parent="#leftAccordion">
          <div class="accordion-body p-2">
            <div id="vfs-tree"></div>
          </div>
        </div>
      </div>
      <div class="accordion-item bg-transparent text-light border-secondary">
        <h2 class="accordion-header" id="acc-watch-h">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc-watch" aria-expanded="false" aria-controls="acc-watch">Watch</button>
        </h2>
        <div id="acc-watch" class="accordion-collapse collapse" aria-labelledby="acc-watch-h" data-bs-parent="#leftAccordion">
          <div class="accordion-body p-2">
            <div class="text-secondary">Todo: variable watch and stack info will appear here.</div>
          </div>
        </div>
      </div>
      <div class="accordion-item bg-transparent text-light border-secondary">
        <h2 class="accordion-header" id="acc-msg-h">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc-msg" aria-expanded="false" aria-controls="acc-msg">Message</button>
        </h2>
        <div id="acc-msg" class="accordion-collapse collapse" aria-labelledby="acc-msg-h" data-bs-parent="#leftAccordion">
          <div class="accordion-body p-2">
            <div class="text-secondary">Todo: console/debug messages will appear here.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="right-drawer" class="drawer drawer-right" aria-label="Home">
  <div class="drawer-header">
    <div class="fw-bold">Home</div>
    <button id="right-drawer-close" class="btn btn-sm btn-outline-light">Close</button>
  </div>
  <div class="drawer-body p-0">
    <iframe id="right-iframe" src="html/index.html" title="Home"></iframe>
  </div>
</div>

</body>
</html>